---
title: "Edge effects on species establishement, growth and survival in an experimental plant invasion"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    self_contained: no
    toc: yes
---

```{r set options, include=F, echo=F}

# knitr::opts_chunk$set(fig.width = 7, fig.height = 3.5)
knitr::opts_chunk$set(dpi = 300)
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(warning = F)
knitr::opts_chunk$set(message = F)
# knitr::opts_chunk$set(fig.asp = .5)
# knitr::opts_chunk$set(eval = F)

# options(na.action = "na.fail")# global model setting for using multimodel inference 'dredge' function

```

```{r load packages}
# library(lme4); library(car); library(sciplot); library(lmerTest); 
# library(MuMIn)
library(plyr); library(dplyr); library(tidyr); library(readr)
library(ggplot2);
library(knitr)

fill_manual <- scale_fill_manual(values = c("grey80", "grey60", "grey40"))
color_manual <- scale_color_manual(values = c("grey40", "grey80"))
```

```{r load data}
seedling_data <- read_csv("data/seedling_growth_survival_data.csv")
germination_data <- read_csv("data/germination_data.csv")
forest_data <- read_csv("data/forest_trees.csv")
light_data <- read_csv("data/light2005_data.csv")
litter_data <- read_csv("data/litter.csv")
soil_moisture_data <- read_csv("data/soil_moisture2005_data.csv")
```

```{r check data}

sites <- data_frame(unique(seedling_data$site_code), unique(seedling_data$site_name))
names(sites) <- c("site_code","site_name")

library(stringr)
germination_data <- rename(germination_data, site_code = site)
# sort(unique(germination_data$site_code))
germination_data$site_code <- germination_data$site_code %>%
  str_sub(., 1,3) %>% 
  str_replace_all(c("Cic"="CH","Dub"="DB","Duc"="DU","Dug"="DG","For"="FR","Gri"="GR","Hdq"="HQ","Lil"="LD","Par"="PR","SR4"="SR","Yel"="TC"))

forest_data <- rename(forest_data, site_code = site)
# unique(forest_data$site_code)
forest_data$site_code <- forest_data$site_code %>% 
  str_replace_all(c("DUCK"="DU","DUB"="DB","DUG"="DG", "SR45"="SR"))

light_data <- rename(light_data, site_code = site)
# unique(light_data$site_code)
light_data$site_code <- light_data$site_code %>% 
  str_replace_all(c("DUCK"="DU","DUB"="DB","DUG"="DG", "SR45"="SR"))

litter_data <- rename(litter_data, site_code = site)
# unique(litter_data$site_code)
litter_data$site_code <- litter_data$site_code %>% 
  str_replace_all(c("DUCK"="DU","DUB"="DB","DUG"="DG", "SR45"="SR"))

soil_moisture_data <- rename(soil_moisture_data, site_code = site)
# unique(soil_moisture_data$site_code)
soil_moisture_data$site_code <- soil_moisture_data$site_code %>% 
  str_replace_all(c("Duck"="DU","DUB"="DB","DUG"="DG", "SR45"="SR","Griffy"="GR","YW"="TC"))


# summary(seedling_data)
# unique(seedling_data$species)
seedling_data <- filter(seedling_data, is.na(species)=="FALSE")
# filter(seedling_data, rgr_ht<0)
seedling_data <- seedling_data %>% 
  rename(age = forest_age) %>%
  mutate(habitat_type = if_else(distance<10,0,ifelse(distance>20, 2, 1)),
         # age = if_else(age=="young", "Young forest", "Mature forest"),
         rgr_ht_days = (log(final_ht06)) - log((initial_ht))/822)
## This calculates relative growth rate per day
## There are 97 negative values in this growth rate. Values are sometimes very inconsistent from the spring 2006 measurement to the final measurement
seedling_data$common_name <- "NA"
seedling_data$common_name[seedling_data$species=="D"] <- "Dogwood"
seedling_data$common_name[seedling_data$species=="A"] <- "Autumn olive"
seedling_data$common_name[seedling_data$species=="H"] <- "Honeysuckle"
seedling_data$common_name[seedling_data$species=="P"] <- "Privet"
seedling_data$common_name[seedling_data$species=="R"] <- "Redbud"
seedling_data$common_name[seedling_data$species=="S"] <- "Spicebush"

seedling_data$common_name <- factor(
  seedling_data$common_name, levels = c("Autumn olive","Honeysuckle","Privet","Dogwood","Redbud","Spicebush"))

seedling_data$status[seedling_data$status=="n"] <- "Native"
seedling_data$status[seedling_data$status=="e"] <- "Non-native"

seedling_data$status <- factor(seedling_data$status, levels = c("Native","Non-native"))

# summary(germination_data)
# unique(germination_data$species)
# filter(germination_data, is.na(seeds_germinated))$comments
germination_data$common_name <- "NA"
germination_data$sci_name = "NA"
germination_data <- germination_data %>% 
  mutate(pct_germinated = 100*(seeds_germinated/seeds_present),
         status = native_exotic,
         habitat_type = if_else(distance<10,0,ifelse(distance>20, 2, 1)))
```

```{r munge site data}

# summary(forest_data)
forest_data <- forest_data %>% 
  rename(distance = dist) %>% 
  mutate(basal_area_m2_ha = trees_in*10*(.0929/.404686))

# unique(forest_data$species)
# filter(forest_data, is.na(species))
forest_distance_data <- forest_data %>% 
  group_by(site_code, age, distance) %>% 
  summarise(
    tree_richness = n_distinct(species),
    avg_dbh = mean(dbh_cm, na.rm = T),
    se_dbh = sd(dbh_cm, na.rm = T)/sqrt( (6 - length(dbh_cm)) ),#6 NA values in DBH
    total_dbh = sum(dbh_cm, na.rm = T),
    avg_basal_area = mean(basal_area_m2_ha, na.rm = T)
  ) %>% 
  ungroup(.)
# 
forest_habitat_data <- forest_data %>%
  mutate(habitat_type = if_else(distance<10,0,ifelse(distance>20, 2, 1))) %>% 
  group_by(site_code, age, habitat_type) %>%
  summarise(
    richness = n_distinct(species),
    avg_dbh = mean(dbh_cm, na.rm = T),
    se_dbh = sd(dbh_cm, na.rm = T)/sqrt(length(dbh_cm)),#6 NA values in DBH
    total_dbh = sum(dbh_cm, na.rm = T),
    avg_basal_area = mean(basal_area_m2_ha, na.rm = T)
  ) %>%
  ungroup(.)

# summary(light_data)
light_distance_data <- light_data %>% 
  group_by(site_code, age, distance) %>% 
  summarise(avg_ppfd = mean(ppfd),
            avg_pct_light = mean(pct_light)) %>% 
  ungroup(.)
light_habitat_data <- light_data %>%
  mutate(habitat_type = if_else(distance<10,0,ifelse(distance>20, 2, 1))) %>% 
  group_by(site_code, age, habitat_type) %>%
  summarise(avg_ppfd = mean(ppfd),
            avg_pct_light = mean(pct_light),
            se_pct_light = sd(pct_light)/sqrt(length(pct_light))) %>%
  ungroup(.)


# summary(litter_data)
litter_data <- litter_data %>% 
  rename(distance = dist) %>% 
  mutate(litter_kg_m2 = litter*(.001/.0625))
# .25*.25 = .0625 m^2
# 1 g = .001 kg
litter_habitat_data <- litter_data %>%
  mutate(habitat_type = if_else(distance<10,0,ifelse(distance>20, 2, 1))) %>% group_by(site_code, age, habitat_type) %>%
  summarise(avg_litter_kg_m2 = mean(litter_kg_m2),
            se_litter_kg_m2 = sd(litter_kg_m2)/sqrt(length(litter_kg_m2)))

# summary(soil_moisture_data)
soil_moisture_habitat_data <- soil_moisture_data %>%
  mutate(habitat_type = if_else(distance<10,0,ifelse(distance>20, 2, 1))) %>%
  group_by(site_code, age, habitat_type) %>%
  summarise(avg_soil_moisture = mean(pct_moisture),
            se_soil_moisture = sd(pct_moisture)/sqrt(length(pct_moisture)))

```

```{r join site to seedling data}

seedling_data <- seedling_data %>% 
  mutate(age = ifelse(age=="young", "Y","M"),
         stem_leaf_ratio = stem_biomass/leaf_biomass,
         f_habitat = factor(habitat_type, levels = c("0","1","2"), labels = c("0-5 m","10-20 m","40-60 m"))) %>%
  left_join(., forest_distance_data) %>% 
  left_join(., light_distance_data) %>% 
  left_join(., litter_data) %>% 
  left_join(., soil_moisture_data) %>% 
  mutate(age = ifelse(age=="Y","Young forest","Mature forest"))

```


```{r site grouped data}

## Group by all factors of interest: site, forest age, distance, species, status
## This site-grouped data should be used for fitting mixed-effects models
## using site_code as a random effect.
site_grouped_data <- seedling_data %>%
  group_by(site_code, age, distance, habitat_type, f_habitat, common_name, status) %>% 
  mutate(
    herbiv_incidence_04 = ifelse(herbivory04>0,1,0),
    herbiv_incidence_05 = ifelse(herbivory05>0,1,0),
    herbiv_incidence_06 = ifelse(herbivory06>0,1,0)
    ) %>% 
  summarise(
    avg_biomass = mean(tot_biomass, na.rm = T),
    # n_obs = length(tot_biomass),
    se_biomass = sd(tot_biomass, na.rm = T)/sqrt(length(tot_biomass)),
    avg_diameter = mean(diameter06, na.rm = T),
    se_diameter = sd(diameter06, na.rm = T)/sqrt(length(diameter06)),
    avg_rgr_ht = mean(rgr_ht_days, na.rm = T),
    se_rgr_ht = sd(rgr_ht_days, na.rm = T)/sqrt(length(rgr_ht_days)),
    avg_height = mean(final_ht06, na.rm = T),
    se_height = sd(final_ht06, na.rm = T)/sqrt(length(final_ht06)),
    avg_num_leaves = mean(num_leaves, na.rm = T),
    se_num_leaves = sd(num_leaves)/sqrt(length(num_leaves)),
    tree_richness = mean(tree_richness),
    avg_dbh = mean(avg_dbh),
    se_dbh = mean(se_dbh),
    total_dbh = mean(total_dbh),
    avg_basal_area = mean(avg_basal_area),
    avg_ppfd = mean(avg_ppfd),
    avg_pct_light = mean(avg_pct_light),
    litter_kg_m2 = mean(litter_kg_m2),
    pct_moisture = mean(pct_moisture),
    avg_herbivory_04 = mean(herbivory04, na.rm = T),
    avg_herbivory_05 = mean(herbivory05, na.rm = T),
    avg_herbivory_06 = mean(herbivory06, na.rm = T),
    avg_h_incidence_04 = mean(herbiv_incidence_04, na.rm = T),
    avg_h_incidence_05 = mean(herbiv_incidence_05, na.rm = T),
    avg_h_incidence_06 = mean(herbiv_incidence_06, na.rm = T),
    avg_h_incidence = rowMeans(cbind(avg_h_incidence_04,avg_h_incidence_05,avg_h_incidence_06), na.rm = T),
    cumulative_h_incidence = rowSums(cbind(avg_h_incidence_04,avg_h_incidence_05,avg_h_incidence_06), na.rm = T)
    ) %>% 
  ungroup(.) %>% 
  mutate(f_age = as.factor(ifelse(age=="Mature forest",0,1)))

```

```{r distance grouped data}

## groups by distance, ignores site
distance_grouped_data <- seedling_data %>%
  # rename(age = forest_age) %>%
  group_by(age, distance, habitat_type, f_habitat, common_name, status) %>% 
  summarise(avg_biomass = mean(tot_biomass, na.rm = T),
            # n_obs = length(tot_biomass),
            se_biomass = sd(tot_biomass, na.rm = T)/sqrt(length(tot_biomass)),
            avg_diameter = mean(diameter06, na.rm = T),
            se_diameter = sd(diameter06, na.rm = T)/sqrt(length(diameter06)),
            avg_rgr_ht = mean(rgr_ht_days, na.rm = T),
            se_rgr_ht = sd(rgr_ht_days, na.rm = T)/sqrt(length(rgr_ht_days)),
            avg_height = mean(final_ht06, na.rm = T),
            se_height = sd(final_ht06, na.rm = T)/sqrt(length(final_ht06)),
            avg_num_leaves = mean(num_leaves, na.rm = T),
            se_num_leaves = sd(num_leaves)/sqrt(length(num_leaves)),
            tree_richness = mean(tree_richness),
            avg_dbh = mean(avg_dbh),
            se_dbh = mean(se_dbh),
            total_dbh = mean(total_dbh),
            avg_basal_area = mean(avg_basal_area),
            avg_ppfd = mean(avg_ppfd),
            avg_pct_light = mean(avg_pct_light),
            litter_kg_m2 = mean(litter_kg_m2),
            pct_moisture = mean(pct_moisture)) %>% 
  ungroup(.)

```

```{r habitat type grouped data}

habitat_grouped_data <- seedling_data %>% 
  group_by(age, habitat_type, f_habitat, common_name, status) %>% 
  summarise(avg_biomass = mean(tot_biomass, na.rm = T),
            # n_obs = length(tot_biomass),
            se_biomass = sd(tot_biomass, na.rm = T)/sqrt(length(tot_biomass)),
            avg_diameter = mean(diameter06, na.rm = T),
            se_diameter = sd(diameter06, na.rm = T)/sqrt(length(diameter06)),
            avg_rgr_ht = mean(rgr_ht_days, na.rm = T),
            se_rgr_ht = sd(rgr_ht_days, na.rm = T)/sqrt(length(rgr_ht_days)),
            avg_height = mean(final_ht06, na.rm = T),
            se_height = sd(final_ht06, na.rm = T)/sqrt(length(final_ht06)),
            avg_num_leaves = mean(num_leaves, na.rm = T),
            se_num_leaves = sd(num_leaves)/sqrt(length(num_leaves)),
            tree_richness = mean(tree_richness),
            avg_dbh = mean(avg_dbh),
            se_dbh = mean(se_dbh),
            total_dbh = mean(total_dbh),
            avg_basal_area = mean(avg_basal_area),
            avg_ppfd = mean(avg_ppfd),
            avg_pct_light = mean(avg_pct_light),
            litter_kg_m2 = mean(litter_kg_m2),
            pct_moisture = mean(pct_moisture)) %>% 
  ungroup(.)

# summary(habitat_grouped_data)
```

```{r join site to germination data}

germination_data <- germination_data %>%
  rename(age = forest_age) %>% 
  left_join(., forest_distance_data) %>% 
  left_join(., light_distance_data) %>% 
  left_join(., litter_data) %>% 
  left_join(., soil_moisture_data)

# xtabs(~ species + native_exotic, germination_data)

```

***

```{r species-grouped-data}
species_grouped_data <- seedling_data %>%
  group_by(common_name, age) %>% 
  summarise(avg_biomass = mean(tot_biomass, na.rm = T),
            # n_obs = length(tot_biomass),
            se_biomass = sd(tot_biomass, na.rm = T)/sqrt(length(tot_biomass)),
            avg_diameter = mean(diameter06, na.rm = T),
            se_diameter = sd(diameter06, na.rm = T)/sqrt(length(diameter06)),
            avg_rgr_ht = mean(rgr_ht_days, na.rm = T),
            se_rgr_ht = sd(rgr_ht_days, na.rm = T)/sqrt(length(rgr_ht_days))
  )
species_grouped_data %>%
  select(common_name:avg_biomass) %>%
  spread(key = age, value = avg_biomass)
```


```{r make species table}
germination_data$common_name[germination_data$species=="D"] <- "Dogwood"
germination_data$common_name[germination_data$species=="A"] <- "Autumn olive"
germination_data$common_name[germination_data$species=="H"] <- "Honeysuckle"
germination_data$common_name[germination_data$species=="P"] <- "Privet"
germination_data$common_name[germination_data$species=="R"] <- "Redbud"
germination_data$common_name[germination_data$species=="S"] <- "Spicebush"

germination_data$sci_name[germination_data$species=="A"] <- "Elaeagnus umbellata"
germination_data$sci_name[germination_data$species=="H"] <- "Lonicera maackii"
germination_data$sci_name[germination_data$species=="P"] <- "Ligustrum obtusifolium"
germination_data$sci_name[germination_data$species=="D"] <- "Cornus florida"
germination_data$sci_name[germination_data$species=="R"] <- "Cercis canadensis"
germination_data$sci_name[germination_data$species=="S"] <- "Lindera benzoin"

germination_data$status[germination_data$status=="N"] <- "Native"
germination_data$status[germination_data$status=="E"] <- "Non-native"

species_table <- germination_data %>% 
  filter(site_code=="BB", distance==0) %>%
  select(species, status, common_name, sci_name)
  
# kable(species_table %>% 
#         mutate(Species = paste(common_name, " ", "(", sci_name, ")", sep="")) %>% 
#         select(Species, Status = status) %>%
#         arrange(Status)
#       )
```

|Species                            |Status     |
|:----------------------------------|:----------|
|Dogwood (*Cornus florida*)           |Native     |
|Redbud (*Cercis canadensis*)         |Native     |
|Spicebush (*Lindera benzoin*)        |Native     |
|Autumn olive (*Elaeagnus umbellata*) |Non-native |
|Honeysuckle (*Lonicera maackii*)     |Non-native |
|Privet (*Ligustrum obtusifolium*)    |Non-native |

***

# Experiment A: Seed germination

* Ten seeds from each of six species (3 invaders, 3 natives) were placed at each distance at each site.

***

# Experiment B: Seedling survival and growth

* Seedlings of six species (3 invaders, 3 natives) were planted at 12 forest sites classified as mature (>60 years) or young (<40 years).  

* Four seedlings of each species at distances of 0, 5, 10, 20, 40, and 60 meters from the roadway edge. 

* All seedlings were 10-15cm tall when planted

***

**H1:** There is a negative effect on survival and growth for all species moving from edge to interior

* Performance will also be poorer in mature versus young forests
    

**H2:** Non-native species perform relatively better near the edge and in young forests.

* Native species perform relatively better in interior locations and in mature forests

***

# Site data
We measured environmental and forest structure characteristics at each distance along each transect at each site.

## Trees
A 10-BAF wedge prism was used to quantify basal area. We identified and measured the DBH of the five nearest trees that were counted as "in" using the wedge prism.

```{r trees}

forest_data$age[forest_data$age=="M"] <- "Mature forest"
forest_data$age[forest_data$age=="Y"] <- "Young forest"
# levels(forest_data$age) <- c("Mature","Young")
forest_data <- forest_data %>% 
  mutate(habitat_type = if_else(distance<10,0,ifelse(distance>20, 2, 1)),
         f_habitat = factor(habitat_type, levels = c("0","1","2"), labels = c("0-5 m","10-20 m","40-60 m")))

#  Basal area calculation: "trees_in"*10 = basal area (ft^2 acre^-1)
#  Conversion to m^2 ha^-1: 1 acre = .404686 hectares; 1 ft^2 = .0929 m^2
# forest_data <- forest_data %>%
#   mutate(basal_area_m2_ha = trees_in*10*(.0929/.404686))



## DBH plot
# ggplot(forest_data, aes(distance, dbh_cm, shape = age, color = age)) +
#   scale_shape_manual(values = c(16,15)) +
#   stat_summary(fun.data = "mean_se", geom = "pointrange", size = .7) +
#   color_manual +
#   theme_classic() +
#   theme(legend.title = element_blank()) +
#   xlab("Distance from road (m)") +
#   ylab("DBH (cm)")

## Basal area plot
ggplot(forest_data, aes(distance, basal_area_m2_ha, shape = age, color = age)) +
  scale_shape_manual(values = c(16,15)) +
  geom_point() +
  geom_smooth(se = T, show.legend = F, alpha = .2) +
  # stat_summary(fun.data = "mean_se", geom = "pointrange", size = .7) +
  # geom_dotplot(binwidth = .5)
  color_manual +
  theme_classic() +
  theme(legend.title = element_blank()) +
  xlab("Distance from road (m)") +
  ylab(expression(paste("Basal area (", {m}^2, "  ", {ha}^-1, ")")))

# ggplot(forest_data %>% group_by(age, species) %>% 
#          summarise(count = length(species)), 
#        aes(species, count, color = species)) +
#   geom_point() +
#   coord_flip() +
#   facet_wrap(~age)

## Summarise mean and SE into new dataframe
avg_forest_data <- forest_data %>%
  group_by(age, f_habitat) %>% 
  summarise(
    richness = n_distinct(species),
    avg_dbh = mean(dbh_cm, na.rm = T),
    se_dbh = sd(dbh_cm, na.rm = T)/sqrt(length(dbh_cm)),
    total_dbh = mean(dbh_cm, na.rm = T),
    avg_basal_area = mean(basal_area_m2_ha, na.rm = T),
    se_basal_area = sd(basal_area_m2_ha, na.rm = T)/sqrt(length(basal_area_m2_ha))
  )

# ggplot(avg_forest_data, aes(age, avg_dbh, fill = habitat_type)) +
#   geom_col(position = "dodge") +
#   geom_errorbar(aes(ymin = avg_dbh - se_dbh, ymax = avg_dbh + se_dbh), width = 0, position = position_dodge(width = .9)) +
#   fill_manual +
#   theme_classic() +
#   theme(legend.title = element_blank()) +
#   xlab("") +
#   ylab("DBH (cm)")

ggplot(avg_forest_data, aes(age, avg_basal_area, fill = f_habitat)) +
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = avg_basal_area - se_basal_area, ymax = avg_basal_area + se_basal_area), width = 0, position = position_dodge(width = .9)) +
  fill_manual +
  theme_classic() +
  theme(legend.title = element_blank()) +
  xlab("") +
  ylab(expression(paste("Basal area (", {m}^2, "  ", {ha}^-1, ")")))

```

Basal area essentially defines young (<40 years) vs. mature forest (>60 years), although the difference is much smaller at the edge (i.e. 0 m).

```{r tree models, eval=F}
skimr::skim(forest_data)
# library(lme4)
# library(lmerTest)

# dbh_lm <- lmer(basal_area ~ distance*age, data = forest_data)
# plot(dbh_lm)
# summary(dbh_lm)
# dbh_lm2 <- glm(dbh_cm ~ habitat_type*age, data = forest_data)
# summary(dbh_lm2)

basal_area_lm <- glm(basal_area_m2_ha ~ distance*age, data = forest_data)
plot(basal_area_lm)
summary(basal_area_lm)

basal_area_lm2 <- glm(basal_area_m2_ha ~ habitat_type*age, data = forest_data)
plot(basal_area_lm2)
summary(basal_area_lm2)

```

## Light availability
In the summer of 2005, photosynthetically active radiation (PAR) was measured as photosynthetic photon flux density (PPFD) at five locations at each distance at each site along a 5 m long transect parallel to the road. From these measurements, we calculated the percent available light at each location as the ratio of the PAR value to the PAR value measured in open sun.

```{r light}

light_data$age[light_data$age=="M"] <- "Mature forest"
light_data$age[light_data$age=="Y"] <- "Young forest"
light_data <- light_data %>% 
  mutate(habitat_type = if_else(distance<10,0,ifelse(distance>20, 2, 1)),
         f_habitat = factor(habitat_type, levels = c("0","1","2"), labels = c("0-5 m","10-20 m","40-60 m")))

# skimr::skim(light_data)

ggplot(light_data, aes(distance, (pct_light), shape = age, color = age)) +
  scale_shape_manual(values = c(16,15)) +
  stat_summary(fun.data = "mean_se", geom = "pointrange", size = .7) +
  # geom_smooth(method = "lm", alpha = .2, se = F) +
  # geom_line(aes(linetype = age)) +
  color_manual +
  theme_classic() +
  theme(legend.title = element_blank()) +
  xlab("Distance from road (m)") +
  ylab("Light (%)")

# qplot(habitat_type, pct_light, data = light_data, geom = "boxplot")

avg_light_data <- light_data %>% 
  group_by(age, f_habitat) %>% 
  summarise(avg_pct_light = mean(pct_light),
            se_pct_light = sd(pct_light)/length(pct_light))

ggplot(avg_light_data, aes(age, avg_pct_light, fill = f_habitat)) +
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = avg_pct_light - se_pct_light, ymax = avg_pct_light + se_pct_light), width = 0, position = position_dodge(width = .9)) +
  fill_manual +
  # scale_fill_manual(values = c("grey90","grey50")) +
  theme_classic() +
  theme(legend.title = element_blank()) +
  xlab("") +
  ylab("Light (%)")

```

Light availability decreases with distance to road with no overall difference between forest age, however, there is substantial variation within and between forest age depending on the specific distance. Averaged across forest age, light availability was greater at the forest edge (0 m) compared to other distances. At mature forest sites, light availability was greatest at the forest edge (0 m), but at young forest sites it was greatest at 20 m from the edge. 

Basically this is a noisy and non-linear relationship. What I would generally expect is relatively high light availability at the edge, then a rapid decline to a steady-state as you move into the forest. 

```{r light models, eval=F}

light_lm <- glm(log10(pct_light) ~ factor(distance)*age, data = light_data)
plot(light_lm)
summary(light_lm)

# summary(MASS::glm.nb(pct_light ~ distance, data = light_data))

light_lm2 <- glm((pct_light) ~ habitat_type, data = light_data)
plot(light_lm2)
summary(light_lm2)

car::Anova(light_lm)

t.test(log10(pct_light) ~ distance, data = filter(light_data, distance==0|distance==40))

```

## Soil moisture
In the summer of 2005, we also collected 125 cm^3^ mineral soil samples at the center of each 5 m transect to measure gravimetric water content.

```{r soil}

soil_moisture_data$age[soil_moisture_data$age=="M"] <- "Mature forest"
soil_moisture_data$age[soil_moisture_data$age=="Y"] <- "Young forest"

ggplot(soil_moisture_data, aes(distance, pct_moisture, shape = age, color = age)) +
  scale_shape_manual(values = c(16,15)) +
  stat_summary(fun.data = "mean_se", geom = "pointrange", size = .7) +
  # geom_smooth(method = "lm", se = F, show.legend = F) +
  color_manual +
  theme_classic() +
  theme(legend.title = element_blank()) +
  xlab("Distance from road (m)") +
  ylab("Soil moisture (%)")


# ggplot(soil_moisture_data, aes(age, pct_moisture, fill = habitat_type)) +
#   geom_boxplot(notch = F) +
#   # geom_violin() +
#   scale_fill_manual(values = c("black", "grey90")) +
#   theme_classic()

## Pooled soil moisture data
# ggplot(soil_moisture_data, aes(distance, pct_moisture)) +
#   # scale_shape_manual(values = c(16,15)) +
#   stat_summary(fun.data = "mean_se", geom = "pointrange", size = .7) +
#   # scale_color_manual(values = c("black", "grey65")) +
#   theme_classic()

soil_moisture_habitat_data$f_habitat <- factor(soil_moisture_habitat_data$habitat_type, levels = c("0","1","2"), labels = c("0-5 m","10-20 m","40-60 m"))
soil_moisture_habitat_data$age[soil_moisture_habitat_data$age=="M"] <- "Mature forest"
soil_moisture_habitat_data$age[soil_moisture_habitat_data$age=="Y"] <- "Young forest"

avg_soil_data <- soil_moisture_habitat_data %>%
  group_by(age, f_habitat) %>%
  summarise(avg_pct_moisture = mean(avg_soil_moisture),
            se_pct_moisture = sd(avg_soil_moisture)/length(avg_soil_moisture))

ggplot(avg_soil_data, aes(age, avg_pct_moisture, fill = f_habitat)) +
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = avg_pct_moisture - se_pct_moisture, ymax = avg_pct_moisture + se_pct_moisture), width = 0, position = position_dodge(width = .9)) +
  fill_manual +
  theme_classic() +
  theme(legend.title = element_blank()) +
  xlab("") +
  ylab("Soil moisture (%)")

# soil_lm <- lm(pct_moisture ~ (distance), data = soil_moisture_data)
# summary(soil_lm)
# car::Anova(soil_lm, type = 3)
## Slope of the overall average line is

# soil_lm2 <- lm(pct_moisture ~ factor(distance), data = soil_moisture_data)
# summary(soil_lm2)
## No overall statistical differences between 0 meter and other distances

```

Overall, soil moisture incarease further from the edge (p = .055), with a stronger relationship at young forest sites than mature forest sites (not significant except at 60 m). Still, the effective difference in the average soil moisture is only a couple percentage points.

## Litter
We collected leaf litter from within a 25 cm x 25 cm PVC frame at each of the six distances from roads at each site in December 2008

```{r litter}

litter_data$age[litter_data$age=="M"] <- "Mature forest"
litter_data$age[litter_data$age=="Y"] <- "Young forest"
litter_data <- litter_data %>% 
  mutate(habitat_type = if_else(distance<10,0,ifelse(distance>20, 2, 1)),
         f_habitat = factor(habitat_type, levels = c("0","1","2"), labels = c("0-5 m","10-20 m","40-60 m")))

ggplot(litter_data, aes(distance, litter_kg_m2, shape = age, color = age)) +
  scale_shape_manual(values = c(16,15)) +
  stat_summary(fun.data = "mean_se", geom = "pointrange", size = .7) +
  # geom_smooth(method = "lm", se = F, show.legend = F) +
  color_manual +
  theme_classic() +
  theme(legend.title = element_blank()) +
  xlab("Distance from road (m)") +
  ylab(expression(paste("Litter (kg ", {m}^-2, ")")))


avg_litter_data <- litter_data %>% 
  group_by(age, f_habitat) %>% 
  summarise(avg_litter_kg_m2 = mean(litter_kg_m2),
            se_litter_kg_m2 = sd(litter_kg_m2)/length(litter_kg_m2))

ggplot(avg_litter_data, aes(age, avg_litter_kg_m2, fill = f_habitat)) +
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = avg_litter_kg_m2 - se_litter_kg_m2, ymax = avg_litter_kg_m2 + se_litter_kg_m2), width = .1, position = position_dodge(width = .9)) +
  fill_manual +
  theme_classic() +
  theme(legend.title = element_blank()) +
  xlab("") +
  ylab(expression(paste("Litter (kg ", {m}^-2, ")")))

# litter_lm <- lm(litter_kg_m2 ~ distance*age, data = litter_data)
# summary(litter_lm)
# litter_lm2 <- lm(litter_kg_m2 ~ habitat_type*age, data = litter_data)
# summary(litter_lm2)
# 
# AIC(litter_lm)
# AIC(litter_lm2)

```

Litter is greater in mature forests than young forests, but decreases with distance from edge after 5 meters in mature forests and increases with distance from edge in young forests. Litter may be especially important for modeling germination.


*** 

# Species data

For all of these, the solid-fill symbols should be the non-native species.

## Experiment 1: Seed germination

```{r germination}

# names(germination_data)
germination_data$age[germination_data$age=="Y"] <- "Young forest"
germination_data$age[germination_data$age=="M"] <- "Mature forest"
germination_data$f_habitat <- factor(germination_data$habitat_type, levels = c("0","1","2"), labels = c("0-5 m","10-20 m","40-60 m"))

germination_data$common_name <- factor(
  germination_data$common_name, levels = c("Autumn olive","Honeysuckle","Privet","Dogwood","Redbud","Spicebush"))
germination_data$status <- factor(germination_data$status, levels = c("Native","Non-native"))


germination_distance_data <- germination_data %>% 
  group_by(status, distance, common_name, age) %>% 
  summarise(avg_germinated = mean(pct_germinated, na.rm = T))

germination_habitat_data <- germination_data %>% 
  group_by(status, f_habitat, habitat_type, common_name, age) %>% 
  summarise(avg_germinated = mean(pct_germinated, na.rm = T))


ggplot(germination_data, aes(distance, pct_germinated)) +
  stat_summary(aes(shape = common_name), fun.data = "mean_se", geom = "point", size = 2.5) +
  geom_smooth(aes(linetype = status), method = "loess", se = T, show.legend = F, color = "grey40", size = .8) +
  # scale_shape_manual(values = c(rep(16, 3), rep(17, 3))) +
  # scale_color_manual(values = c(brewer.pal(3, "RdBu"), brewer.pal(3, "RdBu"))) +
  scale_linetype_manual(values = c(2,1)) +
  # scale_color_brewer(palette = "RdBu") +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Percent germination") +
  xlab("Distance from road (m)")

# ggsave("figures/pct_germinated.png", dpi = 600, width = 7, height = 3.5)

ggplot(germination_distance_data, aes(distance, avg_germinated)) +
  geom_point(aes(shape = common_name), show.legend = T, size = 2.5) +
  geom_line(aes(linetype = common_name)) +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Percent germination") +
  xlab("Distance from road (m)")

ggplot(germination_habitat_data, aes(f_habitat, avg_germinated)) +
  geom_point(aes(shape = common_name), show.legend = T, size = 2.5) +
  geom_line(aes(linetype = common_name, group = common_name)) +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Percent germination") +
  xlab("Distance from road")
write_csv(germination_habitat_data, "model_output_data/germination_raw_fig.csv")


```

Although the relationship between germination and distance from edge was non-linaer, germination was greater overall for non-native than native species and tended to increase with distance for both groups in mature forests. In young forests, germination of native species had a small negative relationship with distance from edge. The greater germination success of non-native species was driven by autumnn olive, which had the highest average germination rate in each forest age (mature: `r mean(filter(germination_data, species=="A", age=="Mature forest")$pct_germinated, na.rm=T)`, young: `r mean(filter(germination_data, species=="A", age=="Young forest")$pct_germinated, na.rm=T)`).

```{r germination averages table, results='asis'}
kable(germination_data %>% 
  group_by(common_name, age, status) %>% 
  summarise(avg_pct_germ = mean(pct_germinated, na.rm = T)) %>% 
  spread(key = age, value = avg_pct_germ) %>% 
  mutate(Average = rowMeans(cbind(`Mature forest`, `Young forest`))) %>%
  rename(Species = common_name, Status = status), 
  digits = 2, caption = "Average germination (%) of seeds for each species in each forest age.")
```


## Experiment 2: Seedling growth and survival

```{r seedling data manipulation}

# names(seedling_data)

seedling_data$age[seedling_data$age=="young"] <- "Young forest"
seedling_data$age[seedling_data$age=="mature"] <- "Mature forest"

seedling_data$f_habitat <- factor(seedling_data$habitat_type, levels = c("0","1","2"), labels = c("0-5 m","10-20 m","40-60 m"))

distance_grouped_data$age[distance_grouped_data$age=="Y"] <- "Young forest"
distance_grouped_data$age[distance_grouped_data$age=="M"] <- "Mature forest"

habitat_grouped_data$age[habitat_grouped_data$age=="Y"] <- "Young forest"
habitat_grouped_data$age[habitat_grouped_data$age=="M"] <- "Mature forest"
```


### Seedling survival
```{r survival}

surv <- select(seedling_data, site_name:status, habitat_type, f_habitat, common_name, starts_with("surv"), avg_basal_area, avg_pct_light, litter_kg_m2, pct_moisture)
surv <- surv %>% gather(year, survival, survival04:survival06)
surv$year[surv$year=="survival04"] <- 2004
surv$year[surv$year=="survival05"] <- 2005
surv$year[surv$year=="survival06"] <- 2006

names(surv)

# names(surv)
survival_2006 <- surv %>% 
  filter(year==2006) %>% 
  group_by(site_code, age, distance, common_name, status, avg_basal_area, avg_pct_light, litter_kg_m2, pct_moisture) %>% 
  summarise(alive = sum(survival),
            dead = length(survival) - alive) %>% 
  ungroup(.)
# names(survival_2006)

survival_distance_data <- surv %>% 
  group_by(year, distance, age, status, common_name) %>% 
  filter(!is.na(survival), year==2006) %>% 
  summarise(pct_survival = 100*sum(survival)/length(survival))

survival_habitat_data <- surv %>% 
  group_by(year, habitat_type, f_habitat, age, status, common_name) %>% 
  filter(!is.na(survival), year==2006) %>% 
  summarise(pct_survival = 100*sum(survival)/length(survival))

ggplot(survival_distance_data, aes(distance, pct_survival)) +
  stat_summary(aes(shape = common_name), fun.data = "mean_se", geom = "point", size = 2.5) +
  geom_smooth(aes(linetype = status), method = "lm", se = F, show.legend = F, color = "grey50", size = .8) +
  scale_linetype_manual(values = c(2,1)) +
  scale_color_brewer(palette = "RdBu") +
  facet_grid(.~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Survival (%)") +
  xlab("Distance from road (m)") +
  ggtitle("Average seedling survival to 2006")


ggplot(survival_distance_data, aes(distance, pct_survival)) +
  # geom_smooth(aes(linetype = common_name), method = "lm", se = F, show.legend = T, color = "grey50", size = .5) +
  geom_point(aes(shape = common_name), size = 2.5, show.legend = T) +
  geom_line(aes(linetype = common_name)) +
  # stat_summary(aes(shape = common_name), fun.data = "mean_se", geom = "point", size = 2.5, show.legend = F) +
  # scale_linetype_manual(values = c(2,1)) +
  # scale_color_brewer(palette = "RdBu") +
  facet_grid(.~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Survival (%)") +
  xlab("Distance from road (m)") +
  ggtitle("Average seedling survival to 2006")


ggplot(survival_habitat_data, aes(f_habitat, pct_survival)) +
  # geom_smooth(aes(linetype = common_name), method = "lm", se = F, show.legend = T, color = "grey50", size = .5) +
  geom_point(aes(shape = common_name), size = 2.5, show.legend = F) +
  geom_line(aes(linetype = common_name, group = common_name)) +
  facet_grid(.~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Survival (%)") +
  xlab("Distance from edge") +
  ggtitle("Average seedling survival to 2006")
write_csv(survival_habitat_data, "model_output_data/survival_raw_fig.csv")
# filter(surv, year == 2006) %>% 
#   group_by(status, age) %>% 
#   summarise(avg_pct_survival = mean(pct_survival))
```

```{r survival averages table, results='asis'}
kable(surv %>%
        filter(!is.na(survival), year==2006) %>% 
        group_by(common_name, status, age) %>%
        summarise(pct_survival = 100*sum(survival)/length(survival)) %>% 
        spread(key = age, value = pct_survival) %>% 
        mutate(Average = rowMeans(cbind(`Mature forest`, `Young forest`))) %>%
  rename(Species = common_name, Status = status), 
  digits = 2, caption = "Proportion of seedlings of each species surviving to 2006")
```


Seedling survival over the duration of the experiment was high across sites and species (`r mean(surv$pct_survival)`). Autumn olive and dogwood had relatively low survival compared to the other species (AO: 49% mature, 50.7% young; DW: 60.4% mature, 41.7% young). Seedling survival for all other species averaged greater than 80%. In mature forests, autumn olive and dogwood both had lower survival with increasing distance from the edge, but in young forest autumn olive tended to have greater survival farther from the edge. 

While these general linear trends with distance are present, the precise relationship with distance from edge is non-linear across all species. In mature forests, most species showed greatest survival at 5 and 10 m from the edge, with the exception of honeysuckle, which had greatest survival at distances of 20 m and greater. Honeysuckle also had the greatest proportion of overall surviving seedlings (94.8%). In contrast, seedling survival in young forests was overall lower for native than non-native species, and also lower at interior versus edge locations for native species, except for spicebush. 


### Seedling height
```{r seedling_height}

ggplot(seedling_data, aes(avg_pct_light, final_ht06)) +
  # stat_summary(aes(shape = common_name), fun.data = "mean_se", geom = "point", size = 2.5) +
  geom_point(aes(color = status, alpha = distance)) +
  geom_smooth(aes(linetype = status), method = "lm", se = F, show.legend = F, color = "grey50") +
  scale_linetype_manual(values = c(2,1)) +
  # scale_color_brewer(palette = "RdBu") +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Height (cm)") +
  xlab("Distance from road (m)")


ggplot(distance_grouped_data, aes(distance, avg_height)) +
  geom_point(aes(shape = common_name), size = 2.5, position = position_dodge(5)) +
  geom_line(aes(linetype = common_name), position = position_dodge(5)) +
  geom_errorbar(aes(ymin = avg_height-se_height, ymax = avg_height+se_height), width = .1, position = position_dodge(5)) +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Height (cm)") +
  xlab("Distance from road (m)")


ggplot(habitat_grouped_data, aes(f_habitat, avg_height)) +
  geom_point(aes(shape = common_name), size = 2.5) +
  geom_line(aes(linetype = common_name, group = common_name)) +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Height (cm)") +
  xlab("Distance")

```


### Seedling diameter
```{r seedling_diameter}

ggplot(seedling_data, aes(avg_pct_light, diameter06)) +
  # stat_summary(aes(shape = common_name), fun.data = "mean_se", geom = "point", size = 2.5) +
  geom_point(aes(color = status, alpha = distance)) +
  geom_smooth(aes(linetype = status), method = "lm", se = F, show.legend = F, color = "grey20") +
  scale_linetype_manual(values = c(2,1)) +
  # scale_color_brewer(palette = "RdBu") +
  facet_grid(.~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Diameter (mm)") +
  xlab("Distance from road (m)")


ggplot(distance_grouped_data, aes(distance, avg_diameter)) +
  geom_point(aes(shape = common_name), size = 2.5) +
  geom_line(aes(linetype = common_name)) +
  geom_errorbar(aes(ymin = avg_diameter-se_diameter, ymax = avg_diameter+se_diameter), width = .1) +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Diameter (mm)") +
  xlab("Distance from road (m)")

ggplot(habitat_grouped_data, aes(f_habitat, avg_diameter)) +
  geom_point(aes(shape = common_name), size = 2.5) +
  geom_line(aes(linetype = common_name, group = common_name)) +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Diameter (mm)") +
  xlab("Distance")
write_csv(habitat_grouped_data, "model_output_data/biomass_diam_rgr_raw_fig.csv")

```


### Seedling biomass
```{r seedling_biomass}

ggplot(seedling_data, aes(distance, tot_biomass)) +
  geom_smooth(aes(linetype = status), method = "lm", se = F, show.legend = F, color = "grey50", size = .8) +
  stat_summary(aes(shape = common_name), fun.data = "mean_se", geom = "point" ) +
  scale_linetype_manual(values = c(2,1)) +
  scale_color_brewer(palette = "RdBu") +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Biomass (g)") +
  xlab("Distance from road (m)")


ggplot(distance_grouped_data, aes(distance, avg_biomass)) +
  geom_line(aes(linetype = common_name, group = common_name)) +
  # geom_smooth(aes(linetype = status), method = "lm", se = F) +
  geom_point(aes(shape = common_name), size = 2.5) +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Biomass (g)") +
  xlab("Distance from road (m)")

ggplot(habitat_grouped_data, aes(f_habitat, avg_biomass)) +
  geom_line(aes(linetype = common_name, group = common_name)) +
  # geom_smooth(aes(linetype = status), method = "lm", se = F) +
  geom_point(aes(shape = common_name), size = 2.5) +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Biomass (g)") +
  xlab("Distance")

```


### Seedling relative growth rate (height)
```{r rel_growth}

ggplot(seedling_data, aes(distance, rgr_ht_days)) +
  stat_summary(aes(shape = common_name), fun.data = "mean_se", geom = "point", size = 2.5) +
  geom_smooth(aes(linetype = status), method = "lm", se = F, show.legend = F, color = "grey50") +
  scale_linetype_manual(values = c(2,1)) +
  scale_color_brewer(palette = "RdBu") +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Relative growth rate (% / day)") +
  xlab("Distance from road (m)") 


ggplot(distance_grouped_data, aes(distance, avg_rgr_ht)) +
  geom_point(aes(shape = common_name)) +
  geom_line(aes(linetype = common_name)) +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Relative growth rate (% / day)") +
  xlab("Distance from road (m)") 


ggplot(habitat_grouped_data, aes(f_habitat, avg_rgr_ht)) +
  geom_point(aes(shape = common_name)) +
  geom_line(aes(linetype = common_name, group = common_name)) +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Relative growth rate (% / day)") +
  xlab("Distance") 

```


### Seedling herbivory
```{r herbivory}

# names(seedling_data)

herbiv <- select(seedling_data, site_name:status, habitat_type, f_habitat, common_name, starts_with("herb"))
herbiv <- herbiv %>% 
  gather(year, herbivory, herbivory04:herbivory06)
herbiv$year[herbiv$year=="herbivory04"] <- 2004
herbiv$year[herbiv$year=="herbivory05"] <- 2005
herbiv$year[herbiv$year=="herbivory06"] <- 2006

# left_join(herbiv, 
#           select(surv, site_code, age, distance, common_name, year, survival))

ggplot(filter(herbiv, year == 2006), aes(distance, herbivory)) +
  stat_summary(aes(shape = common_name), fun.data = "mean_se", geom = "point", size = 2.5) +
  geom_smooth(aes(linetype = status), method = "lm", se = F, show.legend = F, color = "grey50") +
  scale_linetype_manual(values = c(2,1)) +
  scale_color_brewer(palette = "RdBu") +
  facet_grid(.~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Herbivory score in 2006") +
  xlab("Distance from road (m)") 

herbiv_distance_data <- herbiv %>%
  filter(year == "2006") %>%
  group_by(distance, status, age, common_name) %>% 
  summarise(avg_herbivory = mean(herbivory, na.rm = T),
            se_herbivory = sd(herbivory, na.rm = T)/sqrt(length(herbivory)))

herbiv_habitat_data <- herbiv %>%
  filter(year == "2006") %>%
  group_by(habitat_type, f_habitat, status, age, common_name) %>% 
  summarise(avg_herbivory = mean(herbivory, na.rm = T),
            se_herbivory = sd(herbivory, na.rm = T)/sqrt(length(herbivory)))

ggplot(herbiv_distance_data, aes(distance, avg_herbivory)) +
  geom_line(aes(linetype = common_name), show.legend = F) +
  geom_point(aes(shape = common_name), size = 2.5) +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Herbivory score (2006)") +
  xlab("Distance from road (m)")

ggplot(herbiv_habitat_data, aes(f_habitat, avg_herbivory)) +
  geom_errorbar(aes(ymin = avg_herbivory - se_herbivory, ymax = avg_herbivory + se_herbivory), width = 0) +
  geom_line(aes(linetype = common_name, group = common_name), show.legend = F) +
  geom_point(aes(shape = common_name), size = 2.5) +
  facet_wrap(~age) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Herbivory score (2006)") +
  xlab("Distance")

```

We've settled on doing a model to try and explain herbivory. First, I'm looking at whether there was any clear pattern in herbivory from year to year.

```{r herbiv-by-year}

ggplot(herbiv, aes(f_habitat, herbivory)) +
  stat_summary(aes(shape = common_name), fun.data = "mean_se", geom = "pointrange", size = .75, show.legend = T, position = "jitter") +
  # geom_point(aes(shape = common_name)) +
  geom_smooth(aes(linetype = status), method = "loess", se = T, show.legend = F, color = "grey50", alpha = .2) +
  scale_linetype_manual(values = c(2,1)) +
  scale_color_brewer(palette = "RdBu") +
  facet_grid(age~year) +
  theme_bw() +
  theme(strip.background = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank()) +
  ylab("Herbivory score") +
  xlab("Distance from road (m)") 

```


In young forests, herbivory increased with distance from edge for both native and non-native species, but decreased with distance from edge for native species in mature forests. There was no relationship between distance from edge and herbivory for non-native species in mature forests. Herbivory was greater on native than non-native species in both forest types.

Herbivory was categorized as leaf-loss, where 0 = no herbivory, 1 = â‰¤25%, 2 = 26-50%, 3 = 51-75%, 4 = 76-99%, and 5 = 100% leaf removal by herbivores.

What kind of herbivory might this be: Defoliators.

There's not a particularly clear pattern in changes between years, just generally lower for the invasive species. I can still put year in as a factor to test it statistically. It looks like forest age will be important, and probably distance. Some species also appear to be more susceptible than others. I'm thinking a model along the lines of this to start:

herbivory ~ distance + age + year + pct_light + litter


# Modeling

## Species/distance/site level grouping
This grouping of data would theoretically gives an average data point of the performance of each species at each distance at each site (n = `r 12*6*6`). What we actually have is 420 observations, so we have 12 that were missing, I believe lost due to mowing at the edge. Upon investigating where observations were missing, we lost all seedlings at the 0 meter distance at the FR and HQ sites (n = 12), which means we have 10 instead of 12 observations for plants at 0 meters, but effectively equal observations of each species.

```{r where observations are missing, eval=F}
xtabs(~site_code + distance + common_name, data = site_grouped_data)
```

We calculated the average of biomass accumulated, diameter, and relative growth rate for height across the four replicates of each species at each distance at each site. These average values were used as the response variables in regression models. 

response variable for each species as the average value at for that species at each distance and site, e.g., 


We calculated the average of each response variable  

```{r load-modeling-packages}
library(lme4)
library(lmerTest)


## Calculate site-level averages
site_grouped_data <- site_grouped_data %>%
  mutate(site_avg_light = mean(avg_pct_light),
         site_avg_basal_area = mean(avg_basal_area),
         site_avg_litter = mean(litter_kg_m2),
         site_avg_moisture = mean(pct_moisture))

```

We fit linear mixed-effects regressions to model each performance response variable - biomass, final height, and relative growth rate of height. Following methods described in Zuur et al. (2009), we first parameterized a "beyond optimal" model with all possible explanatory variables and potential interactions and used this to find the optimal structure of the random effects component. After finding the optimal random structure we found the optimal fixed structure by removing statistically insignificant interactions and then main effects. The single weakest explanatory variable was removed and the model refit to identify the next weakest explantory variable. This process was repeated until only statistically significant variables remained and accepted this as the final optimal model. We checked the residual plots of the final models to assure there was no major violation of homogeneity in the residual variance. Biomass and diameter responses were natural logarithm-transformed to improve homogeneity of residual variance and normality of the data. 

We used mixed-effects logistic regressions to model germination and survival probabilities for each species.

In all models we allowed the intercept to vary for species and site, and interpret the random intercepts of the performance metrics for each species. Models were fit and evaluated using the "lme4" (@Bates2015) and "lmerTest" (@Kuznetsova2017) packages in the R statistical computing environment. The coefficient estimates from rescaled continuous variables are reported in the figures. Percent light and percent moisture were centered to a mean of zero and divided by two standard deviations, and distance was rescaled to be between zero and one by dividing by the maximum distance value.

The factor f_age represents forest age, and a value of 1 indicates young forests while a value of 0 indicates mature forests.

```{r raw-predictors-pairs-plot, eval=F}
GGally::ggpairs(select(site_grouped_data, distance, tree_richness, avg_basal_area, avg_pct_light, litter_kg_m2, pct_moisture, age), aes(color = age, alpha = .2))
```

 
## Biomass model
```{r biomass-model, eval=F}

# names(grouped_seedling_data)
# summary(grouped_seedling_data)
# grouped_seedling_data
# skimr::skim(grouped_seedling_data)

# a ggplot style pairs plot----
library(GGally)
ggpairs(select(site_grouped_data, avg_biomass, distance, tree_richness, avg_basal_area, avg_pct_light, litter_kg_m2, pct_moisture, age), aes(color = age, alpha = .2))
#relatively strong correlation between basal area and litter; the major differences are related to forest age


## Try get an idea of what is contributing to explaining the variance
biomass_m1 <- lmer(log(avg_biomass) ~ (1|site_code) + (1|status/common_name) + (1|distance) + (1|f_habitat) + (1|age), data = site_grouped_data)
## Age and status have only two categories (groups) which makes them kinda bad random effects; not many groups to average over. Distance could be treated as continuous, or considered to vary within site. The habitat type factor (f_habitat) should probably be treated as "fixed" to better asses the edge effect.
plot(biomass_m1)
summary(biomass_m1)
# confint(biomass_m1)
biomass_m1a <- lmer(log(avg_biomass) ~ (1|site_code) + (1|common_name) + (1|distance), data = site_grouped_data)
## this tells us something, but we could use distance as a continuous variable
biomass_m1b <- lmer(log(avg_biomass) ~ (distance|site_code) + (1|status/common_name),  data = site_grouped_data)# we maybe don't need status per se in the model because it would be implied by the species, and is really more interesting if your just contrasting the native vs. non-native.
biomass_m1c <- lmer(log(avg_biomass) ~ (distance|site_code) + (1|common_name), data = site_grouped_data)# status not as a random effect, maybe not used in this model focused on species response? I think the species effect would then pick up most of the variance attributed to the status grouping
biomass_m1d <- lmer(log(avg_biomass) ~ distance + (distance|site_code) + (1|common_name), data = site_grouped_data)


# Determine best mixed effects model ----

## Following protocol described in Zuur 2009 MEMEER for fitting a mixed effects model. The first part is the effort to find the best random component

biomass_lm <- lm(log(avg_biomass) ~ distance + avg_pct_light + distance*pct_moisture, data = site_grouped_data)
E <- rstandard(biomass_lm)
boxplot(E ~ site_code, data = filter(site_grouped_data, is.na(avg_biomass)=="FALSE"), ylim = c(-3,3))
abline(0,0); axis(2)
boxplot(E ~ common_name, data = filter(site_grouped_data, is.na(avg_biomass)=="FALSE"), ylim = c(-3,3))
abline(0,0); axis(2)

# Some indication that site matters for biomass, though the residuals of any one site are not all above or below the zero line

m1_gls <- nlme::gls(log(avg_biomass) ~ distance + avg_pct_light + distance * pct_moisture, data = filter(site_grouped_data, is.na(avg_biomass)=="FALSE"), method = "REML")
m1_lmer <- lmer(log(avg_biomass) ~ distance + avg_pct_light + distance * pct_moisture + (1|site_code), data = site_grouped_data)
m2_lmer <- lmer(log(avg_biomass) ~ distance + avg_pct_light + distance * pct_moisture + (1|site_code) + (1|common_name), data = site_grouped_data)
AIC(m1_gls)
AIC(m1_lmer)
AIC(m2_lmer)
anova(m1_lmer, m2_lmer)


# 1. Start with as many explanatory variables in the fixed component as possible and then add in various structures to the random component
biomass_mod1 <- nlme::gls(log(avg_biomass) ~ distance + avg_pct_light + litter_kg_m2 + pct_moisture + distance:avg_pct_light + avg_basal_area*age + distance:litter_kg_m2 + distance:pct_moisture, data = filter(site_grouped_data, is.na(avg_biomass)=="FALSE"), method = "REML")

biomass_mod2 <- lmer(log(avg_biomass) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code), data = site_grouped_data)

biomass_mod3 <- lmer(log(avg_biomass) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (distance|site_code), data = site_grouped_data)

biomass_mod4 <- lmer(log(avg_biomass) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code) + (1|common_name), data = site_grouped_data)

biomass_mod5 <- lmer(log(avg_biomass) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (distance|site_code) + (1|common_name), data = site_grouped_data)

biomass_mod6 <- lmer(log(avg_biomass) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (distance|site_code/common_name), data = site_grouped_data)

biomass_mod6a <- lmer(log(avg_biomass) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (distance|site_code/common_name) + (1|common_name), data = site_grouped_data)


# 2. compare AIC (or BIC) values from the different models
AIC(biomass_mod1)
AIC(biomass_mod2)
AIC(biomass_mod3)
AIC(biomass_mod4)
AIC(biomass_mod5)
AIC(biomass_mod6)
AIC(biomass_mod6a)
anova(biomass_mod6, biomass_mod6a)
anova(biomass_mod5, biomass_mod6a)
# mod 4 and 5 are preferred based on lowest AIC, corresponding to either random intercepts for both site and species, or random slope/intercept between distance and site, and a random intercept term for species.
anova(biomass_mod4, biomass_mod5)

summary(biomass_mod4)
summary(biomass_mod5)
# There's some notable correlation between the slop and intercept, but the random slope doesn't capture much variance, so I'm inclined to work eith model 4.

# 3. Check explanatory power of the variables in the fixed component, e.g. p-values or confidence intervals. For me this means refitting using lmerTest because calculating confidence intervals for all of these estimates would take awhile. Keeping in mind that the t-test or F-tests are approximate, therefore p-values near .05 should not be interpreted as convincing
# library(lmerTest)
biomass_mod4 <- lmer(log(avg_biomass) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code) + (1|common_name), data = site_grouped_data)
summary(biomass_mod4)
# Use likelihood ratio test to check significance of "weak" variables
## I think that this usually gives similar results to the summary function
# This requires refitting with maximum likelihood since we want to compare effects in the fixed components

# I'm starting with just the non-significant interaction variables
Form <- formula(biomass_mod4)
m4.full <- lmer(Form, data = site_grouped_data, REML = F)
m4.a <- update(m4.full, .~. -distance:litter_kg_m2)
m4.b <- update(m4.full, .~. -distance:avg_pct_light)
m4.c <- update(m4.full, .~. -avg_basal_area:age)
anova(m4.full, m4.a)
anova(m4.full, m4.b)
anova(m4.full, m4.c)

Form <- formula(log(avg_biomass) ~ distance*avg_pct_light + avg_basal_area*age + litter_kg_m2 + distance*pct_moisture + (1|site_code) + (1|common_name))
m4.full <- lmer(Form, data = site_grouped_data, REML = F)
m4.b <- update(m4.full, .~. -distance:avg_pct_light)
m4.c <- update(m4.full, .~. -avg_basal_area:age)
anova(m4.full, m4.b)
anova(m4.full, m4.c)

Form <- formula(log(avg_biomass) ~ distance*avg_pct_light + avg_basal_area + age + litter_kg_m2 + distance*pct_moisture + (1|site_code) + (1|common_name))
m4.full <- lmer(Form, data = site_grouped_data, REML = F)
m4.b <- update(m4.full, .~. -distance:avg_pct_light)
anova(m4.full, m4.b)

Form <- formula(log(avg_biomass) ~ distance + avg_pct_light + avg_basal_area + age + litter_kg_m2 + distance*pct_moisture + (1|site_code) + (1|common_name))
m4.full <- lmer(Form, data = site_grouped_data, REML = F)
summary(m4.full)
# At this point, all weak interaction effects have been checked and removed

# Now check the main effects of the fixed component
Form <- formula(log(avg_biomass) ~ distance + avg_pct_light + avg_basal_area + age + litter_kg_m2 + distance*pct_moisture + (1|site_code) + (1|common_name))
m4.full <- lmer(Form, data = site_grouped_data, REML = F)
m4.a <- update(m4.full, .~. -litter_kg_m2)
m4.b <- update(m4.full, .~. -avg_basal_area)
anova(m4.full, m4.a)
anova(m4.full, m4.b)

Form <- formula(log(avg_biomass) ~ distance + avg_pct_light + avg_basal_area + age + distance*pct_moisture + (1|site_code) + (1|common_name))
m4.full <- lmer(Form, data = site_grouped_data, REML = F)
summary(m4.full)
m4.b <- update(m4.full, .~. -avg_basal_area)
anova(m4.full, m4.b)

# there's strong correlation between distance and % moisture in the mixed model
bmod <- lmer(log(avg_biomass) ~ distance + avg_pct_light + age + pct_moisture + distance:pct_moisture + (1|site_code) + (1|common_name), data = site_grouped_data)

anova(bmod, m4.b)

bmod_list <- list(
  m1 <- lmer(pct_moisture ~ distance + (1|site_code), data = site_grouped_data),
  m2 <- lmer(log(avg_biomass) ~ distance + avg_pct_light + f_age + pct_moisture + (1|site_code) + (1|common_name), data = site_grouped_data)
)

piecewiseSEM::sem.basis.set(bmod_list)
piecewiseSEM::sem.fit(bmod_list, data = site_grouped_data)
piecewiseSEM::rsquared(bmod_list)
# piecewiseSEM::sem.coefs(bmod_list, data = site_grouped_data) # error
summary(m1)
summary(m2)# indicates that % moisture has no effect after accounting for other variables, so excluding % moisture and the interaction with distance from the model

```

### Diagnostic plots 
```{r add herbivory to model, eval=F}

Form <- formula(log(avg_biomass) ~ distance + avg_pct_light + f_age + (1|site_code) + (1|common_name))
# m4.full <- lmer(Form, data = site_grouped_data, REML = F)
# summary(m4.full)
# This model now has only variables the a significant effect in the fixed component. Now the model needs to be refit with REML
m4.full <- lmer(Form, data = site_grouped_data, REML = T)
# summary(m4.full)
# AIC(m4.full)

# This model is somewhat better than the one below where I omitted age in an earlier iteration
# biomass_mod4a <- lmer(log(avg_biomass) ~ distance + avg_pct_light + distance*pct_moisture + (1|site_code) + (1|common_name), data = site_grouped_data)
# summary(biomass_mod4a)
# AIC(biomass_mod4a)
# anova(biomass_mod4a, m4.full)
# So, use the m4.full model for interpretation. I think I can shorten this by relying on the summary() command for most models, especially if p-values are rather large (maybe greater than >0.2?).

# In the model below I use the factored habitat instead of distance
# biomass_mod4b <- lmer(log(avg_biomass) ~ f_habitat + avg_pct_light + age + pct_moisture*f_habitat + (1|site_code) + (1|common_name), data = site_grouped_data)
# summary(biomass_mod4b)

# m5 <- lmer(log(avg_biomass) ~ distance + avg_pct_light + age + distance*pct_moisture +  + (1|common_name) + (1|site_code) + (distance||site_code), data = site_grouped_data)
# summary(m5)
# anova(m5,m4.full)

# Explore herbivory predictors in model ####

bmod_herbiv <- lmer(log(avg_biomass) ~ distance + avg_pct_light + f_age + avg_herbivory_04 + (1|site_code) + (1|common_name), data = site_grouped_data)
summary(bmod_herbiv)

bmod_herbiv2 <- lmer(log(avg_biomass) ~ distance + avg_pct_light + f_age +  avg_h_incidence_05 + (1|site_code) + (1|common_name), data = site_grouped_data)
summary(bmod_herbiv2)

bmod_herbiv3 <- lmer(log(avg_biomass) ~ distance + avg_pct_light + f_age +  avg_h_incidence_06 + (1|site_code) + (1|common_name), data = site_grouped_data)
summary(bmod_herbiv3)

bmod_herbiv4 <- lmer(log(avg_biomass) ~ distance + avg_pct_light + f_age +  avg_h_incidence + (1|site_code) + (1|common_name), data = site_grouped_data)
summary(bmod_herbiv4)

bmod_herbiv5 <- lmer(log(avg_biomass) ~ distance + avg_pct_light + f_age +  cumulative_h_incidence + (1|site_code) + (1|common_name), data = site_grouped_data)
summary(bmod_herbiv5)

MuMIn::AICc(bmod_herbiv4); MuMIn::r.squaredGLMM(bmod_herbiv4)
MuMIn::AICc(bmod_herbiv5); MuMIn::r.squaredGLMM(bmod_herbiv5)

bmod_herbiv6 <- lmer(log(avg_biomass) ~ distance + avg_pct_light + f_age +  cumulative_h_incidence + (1|site_code) + (cumulative_h_incidence|common_name), data = site_grouped_data)
summary(bmod_herbiv6)
MuMIn::AICc(bmod_herbiv6); MuMIn::r.squaredGLMM(bmod_herbiv6)

bmod_herbiv7 <- lmer(log(avg_biomass) ~ distance + avg_pct_light + f_age +  avg_h_incidence + (1|site_code) + (avg_h_incidence|common_name), data = site_grouped_data)
summary(bmod_herbiv7)
MuMIn::AICc(bmod_herbiv7); MuMIn::r.squaredGLMM(bmod_herbiv7)

# I tried an herbivory predictor from each year using either averaged ordinal scores or average incidence (presence/absence), resulting in data pooled across species at each distance at each site. For the ordinal model, only the average herbivory from the 2004 observation was statistically significant. Using incidence, observations from 2005 and 2006 are statistically significant. Since biomass was measured in 2006 it makes the most sense to use herbivory measured in 2006.

## I've now revised this so that the explanatory variable is the averge incidence of herbivory for each species at each distance, i.e, the number of plants with herbivory/the number of total plants for each species at each distance at each site. This gives the mean proportion of plants that experienced herbivory during the entire study period.

MuMIn::AICc(bmod_herbiv3); MuMIn::r.squaredGLMM(bmod_herbiv3)
MuMIn::AICc(m4.full); MuMIn::r.squaredGLMM(m4.full)
```

```{r final-biomass-model}
# Check fitted biomass model ------- 
biomass_model <- lmer(log(avg_biomass) ~ distance + avg_pct_light + f_age +  avg_h_incidence + (1|site_code) + (avg_h_incidence|common_name), data = site_grouped_data)
# equivalent to bmod_herbiv7 in previous chunk
summary(biomass_model)

plot(biomass_model)
# Residual vs. fitted values show some heterogeneity of variance; spread seems to increase some with fitted values
# Plot residuals against each explanatory variables, looking for patterns in spread.
E2 <- resid(biomass_model, type = "pearson")
boxplot(E2 ~ distance, data = biomass_model@frame)
plot(biomass_model@frame$avg_pct_light, E2)
# maybe some pattern here with light availability, but difficult to make out
plot(biomass_model@frame$avg_h_incidence, E2)
# severe spread in the residuals againes herbivory; effing proportions
# if you cut it around the mean (.70) and only look from there on it's not too bad...


model_summary <- summary(biomass_model)
# correlation between observations from the same site
# (.404^2)/(.404^2 + .217^2 + .614^2 )
## and of the same species
# (.217^2)/(.217^2 + .404^2 + .614^2 )

```


```{r diagnostics with sjPlot}
sjPlot::sjp.lmer(biomass_model, type = "re.qq")
sjPlot::plot_model(biomass_model, type = "diag")
```


```{r scale model data}
## For scaled models, dived by 2*sd, except for distance; rescale distance to be between 0 and 1.

site_grouped_data <- site_grouped_data %>% 
  mutate(scaled_distance = distance/max(distance),
         scaled_pct_moisture = (pct_moisture-mean(pct_moisture, na.rm = T))/(2*sd(pct_moisture)),
         scaled_pct_light = (avg_pct_light-mean(avg_pct_light, na.rm = T))/(2*sd(avg_pct_light)),
         scaled_herbiv_incidence = (avg_h_incidence-mean(avg_h_incidence, na.rm = T))/(2*sd(avg_h_incidence, na.rm = T)))

```

```{r scaled biomass model}

biomass_model_scaled <- lmer(log(avg_biomass) ~ scaled_distance + scaled_pct_light + f_age + scaled_herbiv_incidence + (1|site_code) + (scaled_herbiv_incidence|common_name), data = site_grouped_data)
summary(biomass_model_scaled)
# plot(biomass_model_scaled)

## Checking for non-linearity using an additive mixed model
# ggplot(filter(site_grouped_data, is.na(avg_biomass)=="FALSE"), 
#        aes(avg_pct_light, E2)) +
#   facet_grid(age~.) +
#   geom_point() +
#   geom_smooth() +
#   ylab("Residuals")
# 
# m5 <- mgcv::gamm(log(avg_biomass) ~ s(distance) + avg_pct_light + age + distance*pct_moisture, random = list(site_code = ~1, common_name = ~1), data = site_grouped_data)
# # summary(m5)
# summary(m5$gam)
# anova(m5$gam)
# plot(m5$gam)
# plot(m5$lme)
# summary(m5$lme)

## Scaled "continuous" predictors biomass model
# scaled_biomass_model <- lmer(log(avg_biomass) ~ scale(distance)*scale(pct_moisture) + scale(avg_pct_light) + age + (1 | site_code) + (1 | common_name), data = site_grouped_data)
# summary(scaled_biomass_model)

# confint(biomass_model)

```


### Model coefficients

```{r extract biomass model coefficients}

# lattice::dotplot(fixef(biomass_model))
biomass_ranef <- ranef(biomass_model_scaled, condVar = T)
# lattice::dotplot(biomass_ranef)
biomass_ranef_df <- as.data.frame(biomass_ranef)
write_csv(biomass_ranef_df, "model_output_data/biomass_ranef.csv")

# intercept <- biomass_summary$coefficients[1,1]
biomass_coefs <- coef(biomass_model)

```

```{r biomass-species-ranef-plot}

(biomass_species_ranef_plot <- ggplot(filter(biomass_ranef_df, grpvar=="common_name", term=="(Intercept)"), 
       aes(y = grp, x = condval)) +
  geom_point() +
  # facet_wrap(~term) +
  geom_errorbarh(aes(xmin = condval - 2*condsd, xmax = condval + 2*condsd), height = 0) +
  geom_vline(xintercept = 0, color = "gray70") +
  theme_classic() +
  # theme_bw() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("Biomass species intercepts"))

```

**Random intercepts for each species (above) and each site (below). These are the difference between the estimated intercept across all the groups and the intercept estimated for each group.**

```{r biomass-site-ranef-plot}

(biomass_site_ranef_plot <- ggplot(filter(biomass_ranef_df, grpvar=="site_code"), 
       aes(y = grp, x = condval)) +
  geom_point() +
  geom_errorbarh(aes(xmin = condval - 2*condsd, xmax = condval + 2*condsd), height = 0) +
  geom_vline(xintercept = 0, color = "gray70") +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("Biomass site intercepts"))  

# lattice::qqmath(ranef(biomass_model, condVar = T))

```


```{r biomass-fixef-data, eval=F}
# biomass_fixef <- fixef(biomass_model)
# str(biomass_fixef)
# biomass_summary <- summary(biomass_model)
# str(biomass_summary)
var_names <- c("Intercept","Distance","Pct. light","Forest age: young","Herbivory")
# biomass_fixed <- as.data.frame(biomass_summary$coefficients)
# biomass_fixed$var_names <- var_names
# biomass_confint <- as.data.frame(confint(biomass_model))
# biomass_confint <- biomass_confint[-c(1:5),]
# biomass_fixed <- cbind(biomass_fixed, biomass_confint)
# # str(biomass_fixed)
# biomass_fixed$var_names <- factor(biomass_fixed$var_names, levels = c("Herbivory","Pct. light","Forest age: young","Distance","Intercept"))
# 
# (biomass_coef_plot <- ggplot(filter(biomass_fixed, var_names!="Intercept"), 
#        aes(var_names, Estimate)) +
#   coord_flip() +
#   geom_hline(yintercept = 0, color = "gray70") +
#   geom_point(size = 2) +
#   geom_errorbar(aes(ymin = `2.5 %`, ymax = `97.5 %`), width = 0) +
#   theme_classic() +
#   theme(axis.text.y = element_text(size = 12),
#         axis.text.x = element_text(size = 12),
#         plot.title = element_text(hjust = .5, size = 18)
#         ) +
#   labs(x="", y="") +
#   ggtitle("Biomass means Â± 95% CI"))  


biomass_scaled_summary <- summary(biomass_model_scaled)
# str(biomass_scaled_summary)
biomass_scaled_coef <- as.data.frame(biomass_scaled_summary$coefficients)
biomass_scaled_coef$var_names <- var_names
biomass_confint <- as.data.frame(confint(biomass_model_scaled))
biomass_confint <- biomass_confint[-c(1:5),]
biomass_scaled_coef <- cbind(biomass_scaled_coef, biomass_confint)
write_csv(biomass_scaled_coef, "model_output_data/biomass_fixed_coef.csv")

```


```{r biomass-fixef-plot}

biomass_scaled_coef <- read_csv("model_output_data/biomass_fixed_coef.csv")
biomass_scaled_coef$var_names <- factor(biomass_fixed$var_names, levels = c("Herbivory","Pct. light","Forest age: young","Distance","Intercept"))

(biomass_scaled_coef_plot <- ggplot(filter(biomass_scaled_coef, var_names!="Intercept"), 
       aes(y = var_names, x = Estimate)) +
  # coord_flip() +
  geom_vline(xintercept = 0, color = "gray70") +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = `2.5 %`, xmax = `97.5 %`), height = 0) +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("Biomass means Â± 95% CI")
  )

# lattice::dotplot(coef(biomass_model_scaled))
# species_coefs <- (coef(biomass_model)[[2]])

# lattice::dotplot(ranef(biomass_model_scaled, condVar = T))
# dim(biomass_coefs)
# biomass_coefs[1,1]
# str(as.data.frame(model_summary$coefficients))

# library(sjPlot)
# sjPlot::plot_model(biomass_model_scaled, mdrt.values = "all")

# lattice::dotplot(ranef(biomass_model, condVar = T))
# lattice::qqmath(ranef(biomass_model, condVar = T))

```

Conditional and marginal R^2^ of the biomass model `r MuMIn::r.squaredGLMM(biomass_model_scaled)`  AIC: `r MuMIn::AICc(biomass_model)`

All species generated more aboveground biomass in young forests and at locations with greater light availability. Biomass production decreased with distance from the road/forest edge and (interestingly) with greater soil moisture, however, there was a significant interaction between distance and soil moisture indicating greater soil moisture at distances farther from the edge.

The random intercepts for each species show that native species generated less biomass than non-native species, with spicebush and dogwood performing particularly poorly. For the non-native species, privet and autumn olive were especially good at amassing biomass, with honeysuckle performing slightly less well.

Site-level biomass production was greater at CH, PR, LD, and SR, while lower at DG, FR, and GR. The intercepts for the other five sites all had confidence error estimates crossing zero, with absolute values of the intercepts <0.12.


I'm exploring making plots of the marginal effects for each group in the random effects, particulalry for species, with special interest in the relationship with distance (edge effects). 

```{r sjPlot-biomass}

biomass_sjplot <- sjPlot::sjp.lmer(biomass_model, type = "ri.slope", prnt.plot = F)
# sjPlot::plot_model(biomass_model, terms = c("distance", "f_age"), type = "eff")
# sjPlot::plot_model(biomass_model, terms = c("distance", "f_age"), type)
```

**Plot the marginal effect of distance on biomass for each species**
```{r marginal-biomass-distance-plot}
# sjPlot::sjp.lmer(biomass_model, type = "fe.slope")
biomass_distance <- biomass_sjplot$plot[[5]]
biomass_distance$data$y <- exp(biomass_distance$data$y)
# biomass_distance <- biomass_distance$data
(biomass_distance_lines <- biomass_distance +
  # geom_line() +
  # geom_point(data = site_grouped_data, aes(distance, log(avg_biomass))) +
  scale_color_brewer(palette = "BrBG") +
  labs(y = "Biomass (g)", x = "Distance (m)", title = "") +
  theme_classic() +
  theme(legend.title = element_blank())
)

```


**Plot the random-slope-random-intercept for the effect of herbivory on the biomass for each species**
```{r biomass-herbiv-rsri-plot}

biomass_rsri <- sjPlot::sjp.lmer(biomass_model, type = "rs.ri", show.legend = T, prnt.plot = F)

biomass_herbiv_rsri <- biomass_rsri$plot[[1]]
biomass_herbiv_rsri$data$y = exp(biomass_herbiv_rsri$data$y)

(biomass_herbiv_rsri_plot <- ggplot(biomass_herbiv_rsri$data,
                                    aes(x,y,color=grp)) +
    geom_line() +
  # geom_path() +
  # geom_line() +
    
  # geom_point(data = site_grouped_data, aes(distance, log(avg_biomass))) +
  scale_color_brewer(palette = "BrBG") +
  labs(y = "Biomass (g)", x = "Average herbivory incidence", title = "") +
  theme_classic() +
  theme(legend.title = element_blank())
)

```


~~What about fitting a separate models for each species? I don't think this is necessary unless we want to be able to say something specific about the relationship between the response and specific predictors for each species. I think it is reasonable to assume that the plants generally respond similarly to things like soil moisture and light availability.~~

```{r species-level-model, eval = F}

ao_biomass <- lmer(log(avg_biomass) ~ avg_pct_light + age + distance*pct_moisture + (distance | site_code), data = filter(site_grouped_data, common_name == "Autumn olive"))
summary(ao_biomass)
plot(ao_biomass)

(.498^2)/(.498^2 + .702^2)
# ~33.5% of the residual variance in autumn olive biomass is explained by the site-level random effect

ao_biomass2 <- lmer(log(avg_biomass) ~ f_habitat*age + avg_pct_light + (distance | site_code), data = filter(site_grouped_data, common_name == "Autumn olive"))
summary(ao_biomass2)

ao_biomass3 <- lmer(log(avg_biomass) ~ f_habitat + (distance | site_code), data = filter(site_grouped_data, common_name == "Autumn olive", age == "Mature forest"))
summary(ao_biomass3)

lattice::dotplot(ranef(ao_biomass, condVar = T))


```


## Diameter model
```{r find diameter model, eval=F}
# find random component ----
hist(log(site_grouped_data$avg_diameter))
# log transformation improves normality

diam_mod1 <- nlme::gls(log(avg_diameter) ~ distance*avg_pct_light + distance*age + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture, data = filter(site_grouped_data, is.na(avg_diameter)=="FALSE"), method = "REML")

diam_mod2 <- lmer(log(avg_diameter) ~ distance*avg_pct_light + distance*age + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code), data = site_grouped_data)

diam_mod3 <- lmer(log(avg_diameter) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (distance|site_code), data = site_grouped_data)

diam_mod4 <- lmer(log(avg_diameter) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code) + (1|common_name), data = site_grouped_data)

diam_mod5 <- lmer(log(avg_diameter) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (distance|site_code) + (1|common_name), data = site_grouped_data)

AIC(diam_mod1)
AIC(diam_mod2)
AIC(diam_mod3)
AIC(diam_mod4)# best random effects model based on AIC
AIC(diam_mod5)

# find fixed component -----
summary(diam_mod4)
Form <- formula(log(avg_diameter) ~ distance + avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code) + (1|common_name))
diam_mod4a <- lmer(Form, data = site_grouped_data, REML = F)
summary(diam_mod4a)

Form <- formula(log(avg_diameter) ~ distance + avg_pct_light + avg_basal_area*age + litter_kg_m2 + distance*pct_moisture + (1|site_code) + (1|common_name))
diam_mod4b <- lmer(Form, data = site_grouped_data, REML = F)
summary(diam_mod4b)

Form <- formula(log(avg_diameter) ~ distance + avg_pct_light + avg_basal_area + age + litter_kg_m2 + distance*pct_moisture + (1|site_code) + (1|common_name))
diam_mod4c <- lmer(Form, data = site_grouped_data, REML = F)
summary(diam_mod4c)

Form <- formula(log(avg_diameter) ~ distance + avg_pct_light + avg_basal_area + age + distance*pct_moisture + (1|site_code) + (1|common_name))
diam_mod4d <- lmer(Form, data = site_grouped_data, REML = F)
summary(diam_mod4d)

Form <- formula(log(avg_diameter) ~ distance + avg_pct_light + age + distance*pct_moisture + (1|site_code) + (1|common_name))
diam_mod4e <- lmer(Form, data = site_grouped_data, REML = F)
summary(diam_mod4e)

# there's strong correlation between distance and % moisture in the mixed model
dmod <- lmer(log(avg_diameter) ~ distance + avg_pct_light + age + (1|site_code) + (1|common_name), data = site_grouped_data)

anova(dmod, diam_mod4e)

dmod_list <- list(
  m1 <- lmer(pct_moisture ~ distance + (1|site_code), data = site_grouped_data),
  m2 <- lmer(log(avg_diameter) ~ distance + avg_pct_light + f_age + pct_moisture + (1|site_code) + (1|common_name), data = site_grouped_data)
)

piecewiseSEM::sem.basis.set(dmod_list)
piecewiseSEM::sem.fit(dmod_list, data = site_grouped_data)
piecewiseSEM::rsquared(dmod_list)
# piecewiseSEM::sem.coefs(bmod_list, data = site_grouped_data) # error
summary(m1)
summary(m2)# indicates that % moisture has no effect after accounting for other variables, so excluding % moisture and the interaction with distance from the model

diam_model_h1 <- lmer(log(avg_diameter) ~ distance + avg_pct_light + age + avg_herbivory_06 + (1|site_code) + (1|common_name), data = site_grouped_data)
summary(diam_model_h1)

diam_model_h2 <- lmer(log(avg_diameter) ~ distance + avg_pct_light + age + avg_h_incidence_06 + (1|site_code) + (1|common_name), data = site_grouped_data)
summary(diam_model_h2)

MuMIn::AICc(dmod); MuMIn::r.squaredGLMM(dmod)
MuMIn::AICc(diam_model_h2); MuMIn::r.squaredGLMM(diam_model_h2)

diam_model_h2a <- lmer(log(avg_diameter) ~ distance + avg_pct_light + age + avg_h_incidence_06 + (1|site_code) + (avg_h_incidence_06|common_name), data = site_grouped_data)
summary(diam_model_h2a)
MuMIn::AICc(diam_model_h2a); MuMIn::r.squaredGLMM(diam_model_h2a)

diam_model_h3 <- lmer(log(avg_diameter) ~ distance + avg_pct_light + age + cumulative_h_incidence + (1|site_code) + (1|common_name), data = site_grouped_data)
summary(diam_model_h3)
MuMIn::AICc(diam_model_h3); MuMIn::r.squaredGLMM(diam_model_h3)

diam_model_h4 <- lmer(log(avg_diameter) ~ distance + avg_pct_light + age + cumulative_h_incidence + (1|site_code) + (cumulative_h_incidence|common_name), data = site_grouped_data)
summary(diam_model_h4)
MuMIn::AICc(diam_model_h4); MuMIn::r.squaredGLMM(diam_model_h4)

diam_model_h5 <- lmer(log(avg_diameter) ~ distance + avg_pct_light + age + avg_h_incidence + (1|site_code) + (avg_h_incidence|common_name), data = site_grouped_data)
summary(diam_model_h5)
MuMIn::AICc(diam_model_h5); MuMIn::r.squaredGLMM(diam_model_h5)

```

```{r final diameter model}

diam_model <- lmer(log(avg_diameter) ~ distance + avg_pct_light + age + avg_h_incidence + (1|site_code) + (avg_h_incidence|common_name), data = site_grouped_data)
summary(diam_model)

# model diagnostics - residual plots ----
plot(diam_model)

E2 <- resid(diam_model, type = "pearson")
# plot(diam_model@frame$distance, E2)
boxplot(E2 ~ distance, data = diam_model@frame)
boxplot(E2 ~ age, data = diam_model@frame)
plot(diam_model@frame$avg_pct_light, E2)
# maybe some pattern here with light availability, but difficult to make out
plot(diam_model@frame$avg_h_incidence, E2)


# model with scaled predictors ----
diam_model_scaled <- lmer(log(avg_diameter) ~ scaled_distance + scaled_pct_light + age + scaled_herbiv_incidence + (1|site_code) + (scaled_herbiv_incidence|common_name), data = site_grouped_data)
summary(diam_model_scaled)

```

```{r diameter-species-ranef-plot}

diam_ranef <- ranef(diam_model_scaled, condVar = T)

# lattice::dotplot(ranef(diam_model, condVar = T))
# lattice::qqmath(ranef(biomass_model, condVar = T))
diam_ranef_df <- as.data.frame(diam_ranef)
write_csv(diam_ranef_df, "model_output_data/diam_ranef.csv")

(diam_species_ranef_plot <- ggplot(filter(diam_ranef_df, grpvar=="common_name", term=="(Intercept)"), 
       aes(y = grp, x = condval)) +
  geom_point() +
  geom_errorbarh(aes(xmin = condval - 2*condsd, xmax = condval + 2*condsd), height = 0) +
  geom_vline(xintercept = 0, color = "gray70") +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("Diameter species intercepts"))

```

**Random effects for species and site on diameter growth response**

```{r diameter-site-ranef-plot}
(diam_site_ranef_plot <- ggplot(filter(diam_ranef_df, grpvar=="site_code"), 
       aes(y = grp, x = condval)) +
  geom_point() +
  geom_errorbarh(aes(xmin = condval - 2*condsd, xmax = condval + 2*condsd), height = 0) +
  geom_vline(xintercept = 0, color = "gray70") +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("Diameter site intercepts"))

```


```{r diameter-fixef-data, eval=F}
# diam_summary <- summary(diam_model)
# str(diam_summary)
var_names <- c("Intercept","Distance","Pct. light","Forest age: young","Herbivory")
# diam_fixed <- as.data.frame(diam_summary$coefficients)
# diam_fixed$var_names <- var_names
# diam_confint <- as.data.frame(confint(diam_model))
# diam_confint <- diam_confint[-c(1:3),]
# diam_fixed <- cbind(diam_fixed, diam_confint)
# # str(diam_fixed)
# 
# (diam_coef_plot <- ggplot(filter(diam_fixed, var_names!="Intercept"), 
#        aes(y = var_names, x = Estimate)) +
#   # coord_flip() +
#   geom_vline(xintercept = 0, color = "gray70") +
#   geom_point(size = 2) +
#   geom_errorbarh(aes(xmin = `2.5 %`, xmax = `97.5 %`), height = 0) +
#   theme_classic() +
#   theme(axis.text.y = element_text(size = 12),
#         axis.text.x = element_text(size = 12),
#         plot.title = element_text(hjust = .5, size = 18)
#         ) +
#   labs(x="", y="") +
#   ggtitle("Diameter eans Â± 95% CI"))


diam_scaled_summary <- summary(diam_model_scaled)
# str(diam_scaled_summary)
diam_scaled_coef <- as.data.frame(diam_scaled_summary$coefficients)
diam_scaled_coef$var_names <- var_names
diam_confint <- as.data.frame(confint(diam_model_scaled))
diam_confint <- diam_confint[-c(1:5),]
diam_scaled_coef <- cbind(diam_scaled_coef, diam_confint)
write_csv(diam_scaled_coef, "model_output_data/diam_fixed_coef.csv")

```

**Coefficient estimates (Â±95% confidence intervals) on the diameter growth response**

```{r diameter-fixef-plot}

diam_scaled_coef <- read_csv("model_output_data/diam_fixed_coef.csv")
diam_scaled_coef$var_names <- factor(diam_scaled_coef$var_names, levels = c("Herbivory","Pct. light","Forest age: young","Distance","Intercept"))

(diam_scaled_coef_plot <- ggplot(filter(diam_scaled_coef, var_names!="Intercept"), 
       aes(y = var_names, x = Estimate)) +
  # coord_flip() +
  geom_vline(xintercept = 0, color = "gray70") +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = `2.5 %`, xmax = `97.5 %`), height = 0) +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("Diam means Â± 95% CI")
  )

```

Conditional and marginal R^2^ estimated for the diameter model `r MuMIn::r.squaredGLMM(diam_model_scaled)`  AIC: `r MuMIn::AICc(diam_model_scaled)`

Seedling diameter increased with light availability, was greater in younger forests, (not significantly) decreased with distance, and (not significantly) increased with herbivory.

**Plot marginal effect of distance on diameter growth for each species**
```{r sjplot-diameter}

diam_sjplot_rislope <- sjPlot::sjp.lmer(diam_model, type = "ri.slope", prnt.plot = F)
diam_distance <- diam_sjplot_rislope$plot[[5]]
diam_distance$data$y <- exp(diam_distance$data$y)

(diam_distance_lines <- diam_distance +
  # geom_line() +
  # geom_point(data = site_grouped_data, aes(distance, log(avg_biomass))) +
  scale_color_brewer(palette = "BrBG") +
  labs(y = "Diameter (mm)", x = "Distance", title = "") +
  theme_classic() +
  theme(legend.title = element_blank())
  )

# m1 <- lmer(log(avg_diameter) ~ distance + avg_pct_light + age + (1 | site_code) + (distance | common_name), site_grouped_data)
## I was going to investigate the rs-ri of distance and species, but the model failed to converge

```

**Plot the random-slope-random-intercept for the marginal effect of herbivory on the diameter of each species**
```{r diam-herbiv-rsri-plot}
# sjPlot::sjp.lmer(diam_model_h4, type = "rs.ri", show.legend = T)
diam_sjplot_rsri <- sjPlot::sjp.lmer(diam_model, type = "rs.ri", show.legend = T, prnt.plot = F) 

diam_rsri_plot <- diam_sjplot_rsri$plot[[1]]
diam_rsri_plot$data$y <- exp(diam_rsri_plot$data$y)
(diam_rsri_plot <- ggplot(diam_rsri_plot$data, aes(x,y,color = grp)) +
  geom_line() +
  theme_classic() +
  scale_color_brewer(palette = "BrBG") +
  xlab("Average herbivory incidence") +
  ylab("Diameter (mm)") +
  theme(legend.title = element_blank())
)

```


## Relative growth rate model
The units of relative growth rate are percent change per day (I think).

```{r find rgr model, eval=F}

hist(site_grouped_data$avg_rgr_ht)# looks normally distributed

# find random component ----
rgr_mod1 <- nlme::gls((avg_rgr_ht) ~ distance*avg_pct_light + distance*age + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture, data = filter(site_grouped_data, is.na(avg_rgr_ht)=="FALSE"), method = "REML")

rgr_mod2 <- lmer((avg_rgr_ht) ~ distance*avg_pct_light + distance*age + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code), data = site_grouped_data)

rgr_mod3 <- lmer((avg_rgr_ht) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (distance|site_code), data = site_grouped_data)

rgr_mod4 <- lmer((avg_rgr_ht) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code) + (1|common_name), data = site_grouped_data)

rgr_mod4a <- lmer((avg_rgr_ht) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code/common_name), data = site_grouped_data)

rgr_mod4b <- lmer((avg_rgr_ht) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (distance|site_code/common_name), data = site_grouped_data)

rgr_mod5 <- lmer((avg_rgr_ht) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (distance|site_code) + (1|common_name), data = site_grouped_data)

# rgr_mod6 <- lmer((avg_rgr_ht) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code) + (distance|common_name), data = site_grouped_data)

AIC(rgr_mod1)
AIC(rgr_mod2)
AIC(rgr_mod3)
AIC(rgr_mod4)# 2nd best model, and small diff in AIC
AIC(rgr_mod5)# best random effects model based on AIC
# AIC(rgr_mod6)
anova(rgr_mod4,rgr_mod5)
anova(rgr_mod4, rgr_mod4a)
anova(rgr_mod4,rgr_mod4b)
anova(rgr_mod4a,rgr_mod4b)
# reinforcing that the difference between models isn't especially strong

# find fixed component ----
rgr_mod4_ML <- refitML(rgr_mod4)
form <- formula(avg_rgr_ht ~ avg_pct_light + avg_basal_area * age + distance * litter_kg_m2 + distance * pct_moisture + (1 | site_code) + (1 | common_name))
rgr_mod4a <- lmer(form, data = site_grouped_data, REML = F)
anova(rgr_mod4_ML, rgr_mod4a)
summary(rgr_mod4a)

form <- formula(avg_rgr_ht ~ avg_pct_light + avg_basal_area + age + distance * litter_kg_m2 + distance * pct_moisture + (1 | site_code) + (1 | common_name))
rgr_mod4b <- lmer(form, data = site_grouped_data, REML = F)
anova(rgr_mod4_ML, rgr_mod4b)
summary(rgr_mod4b)

form <- formula(avg_rgr_ht ~ avg_pct_light + avg_basal_area + age + litter_kg_m2 + distance * pct_moisture + (1 | site_code) + (1 | common_name))
rgr_mod4c <- lmer(form, data = site_grouped_data, REML = F)
anova(rgr_mod4_ML, rgr_mod4c)
summary(rgr_mod4c)

form <- formula(avg_rgr_ht ~ avg_pct_light + avg_basal_area + age + distance * pct_moisture + (1 | site_code) + (1 | common_name))
rgr_mod4d <- lmer(form, data = site_grouped_data, REML = F)
anova(rgr_mod4_ML, rgr_mod4d)
summary(rgr_mod4d)

form <- formula(avg_rgr_ht ~ distance + avg_pct_light + age + distance * pct_moisture + (1 | site_code) + (1 | common_name))
rgr_mod4e <- lmer(form, data = site_grouped_data, REML = F)
anova(rgr_mod4_ML, rgr_mod4e)
summary(rgr_mod4e)
# percent moisture is not terribly convincing at p = .044, but the interaction with distance is pretty strong statistically

# there's strong correlation between distance and % moisture in the mixed model
rmod <- lmer(avg_rgr_ht ~ distance + avg_pct_light + age + (1|site_code) + (1|common_name), data = site_grouped_data)

anova(rmod, rgr_mod4e)

rmod_list <- list(
  m1 <- lmer(pct_moisture ~ distance + (1|site_code), data = site_grouped_data),
  m2 <- lmer(avg_rgr_ht ~ distance + avg_pct_light + f_age + pct_moisture + (1|site_code) + (1|common_name), data = site_grouped_data)
)

piecewiseSEM::sem.basis.set(rmod_list)
piecewiseSEM::sem.fit(rmod_list, data = site_grouped_data)
piecewiseSEM::rsquared(rmod_list)
# piecewiseSEM::sem.coefs(bmod_list, data = site_grouped_data) # error
summary(m1)
summary(m2)# indicates that % moisture has no effect after accounting for other variables, so excluding % moisture and the interaction with distance from the model

rmod_herbiv1 <- lmer(avg_rgr_ht ~ distance + avg_pct_light + age + avg_herbivory_06 + (1|site_code) + (1|common_name), data = site_grouped_data)
summary(rmod_herbiv1)

rmod_herbiv2 <- lmer(avg_rgr_ht ~ distance + avg_pct_light + age + avg_h_incidence_06 + (1|site_code) + (1|common_name), data = site_grouped_data)
summary(rmod_herbiv2)

MuMIn::AICc(rmod_herbiv1); MuMIn::r.squaredGLMM(rmod_herbiv1)
MuMIn::AICc(rmod_herbiv2); MuMIn::r.squaredGLMM(rmod_herbiv2)

rmod_herbiv3 <- lmer(avg_rgr_ht ~ distance + avg_pct_light + age + avg_h_incidence + (1|site_code) + (avg_h_incidence|common_name), data = site_grouped_data)
summary(rmod_herbiv3)
MuMIn::AICc(rmod_herbiv3); MuMIn::r.squaredGLMM(rmod_herbiv3)

rmod_herbiv4 <- lmer(avg_rgr_ht ~ distance + avg_pct_light + age + cumulative_h_incidence + (1|site_code) + (cumulative_h_incidence|common_name), data = site_grouped_data)
summary(rmod_herbiv4)
MuMIn::AICc(rmod_herbiv4); MuMIn::r.squaredGLMM(rmod_herbiv4)

```


```{r final rgr model}

rgr_model <- lmer(avg_rgr_ht ~ distance + avg_pct_light + age + avg_h_incidence + (1|site_code) + (avg_h_incidence|common_name), data = site_grouped_data, REML = T)
summary(rgr_model)

# model diagnostics ----
plot(rgr_model)

E2 <- resid(rgr_model, type = "pearson")
# plot(diam_model@frame$distance, E2)
boxplot(E2 ~ distance, data = rgr_model@frame)
boxplot(E2 ~ age, data = rgr_model@frame)
plot(rgr_model@frame$avg_pct_light, E2)
# maybe some pattern here with light availability, but difficult to make out
plot(rgr_model@frame$avg_h_incidence, E2)

rgr_model_scaled <- lmer(avg_rgr_ht ~ scaled_distance + scaled_pct_light + age + scaled_herbiv_incidence + (1|site_code) + (scaled_herbiv_incidence|common_name), data = site_grouped_data)
# summary(rgr_model_scaled)

```


```{r rgr-species-ranef-plot}

rgr_ranef <- ranef(rgr_model_scaled, condVar = T)

# coef(rgr_model)$common_name

# lattice::dotplot(ranef(rgr_model, condVar = T))
# lattice::qqmath(ranef(biomass_model, condVar = T))
rgr_ranef_df <- as.data.frame(rgr_ranef)
write.csv(rgr_ranef_df, "model_output_data/rgr_ranef.csv")

(rgr_species_ranef_plot <- ggplot(
  filter(rgr_ranef_df, grpvar=="common_name", term=="(Intercept)"), 
       aes(y = grp, x = condval)) +
  geom_point() +
  geom_errorbarh(aes(xmin = condval - 2*condsd, xmax = condval + 2*condsd), height = 0) +
  geom_vline(xintercept = 0, color = "gray70") +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("RGR species intercepts"))
```

**Random intercepts of species (above) and site (below) for the relative growth rate response**

```{r rgr-site-ranef-plot}

(rgr_site_ranef_plot <- ggplot(filter(rgr_ranef_df, grpvar=="site_code"), 
       aes(y = grp, x = condval)) +
  geom_point() +
  geom_errorbarh(aes(xmin = condval - 2*condsd, xmax = condval + 2*condsd), height = 0) +
  geom_vline(xintercept = 0, color = "gray70") +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("RGR site intercepts"))

```


```{r rgr-fixef-data, eval=F}
# rgr_summary <- summary(rgr_model)
# str(rgr_summary)
var_names <- c("Intercept","Distance","Pct. light","Forest age: young","Herbivory")
# rgr_fixed <- as.data.frame(rgr_summary$coefficients)
# rgr_fixed$var_names <- var_names
# rgr_confint <- as.data.frame(confint(rgr_model))
# rgr_confint <- rgr_confint[-c(1:3),]
# rgr_fixed <- cbind(rgr_fixed, rgr_confint)
# # str(rgr_fixed)
# 
# (rgr_coef_plot <- ggplot(filter(rgr_fixed, var_names!="Intercept"), 
#        aes(y = var_names, x = Estimate)) +
#   # coord_flip() +
#   geom_vline(xintercept = 0, color = "gray70") +
#   geom_point(size = 2) +
#   geom_errorbarh(aes(xmin = `2.5 %`, xmax = `97.5 %`), height = 0) +
#   theme_classic() +
#   theme(axis.text.y = element_text(size = 12),
#         axis.text.x = element_text(size = 12),
#         plot.title = element_text(hjust = .5, size = 18)
#         ) +
#   labs(x="", y="") +
#   ggtitle("RGR means Â± 95% CI"))


rgr_scaled_summary <- summary(rgr_model_scaled)
# str(rgr_scaled_summary)
rgr_scaled_coef <- as.data.frame(rgr_scaled_summary$coefficients)
rgr_scaled_coef$var_names <- var_names
rgr_confint <- as.data.frame(confint(rgr_model_scaled))
rgr_confint <- rgr_confint[-c(1:5),]
rgr_scaled_coef <- cbind(rgr_scaled_coef, rgr_confint)

write.csv(rgr_scaled_coef, "model_output_data/rgr_fixed_coef.csv")
```

**Scaled coefficient estimates (relative effects) Â±95% confidence intervals for effects of distance, forest age, available light, and herbivory on relative growth rate**

```{r rgr-fixef-plot}

rgr_scaled_coef <- read_csv("model_output_data/rgr_fixed_coef.csv")
rgr_scaled_coef$var_names <- factor(rgr_scaled_coef$var_names, levels = c("Herbivory","Pct. light","Forest age: young","Distance","Intercept"))

(rgr_scaled_coef_plot <- ggplot(filter(rgr_scaled_coef, var_names!="Intercept"), 
       aes(y = var_names, x = Estimate)) +
  # coord_flip() +
  geom_vline(xintercept = 0, color = "gray70") +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = `2.5 %`, xmax = `97.5 %`), height = 0) +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("RGR means Â± 95% CI")
  )

```


```{r plot rgr model, eval=F}

lattice::dotplot(ranef(rgr_model, condVar = T))
# lattice::qqmath(ranef(rgr_model, condVar = T))

rgr_coefs <- coef(rgr_model)
rgr_species_coefs <- (coef(rgr_model)[[2]])
# 
# lattice::dotplot(ranef(rgr_mod4a, condVar = T))
# lattice::qqmath(ranef(rgr_mod4a, condVar = T))
# 
# lattice::dotplot(ranef(rgr_mod4b, condVar = T))
# lattice::qqmath(ranef(rgr_mod4b, condVar = T))
# 
# lattice::dotplot(ranef(rgr_mod6, condVar = T))
# lattice::qqmath(ranef(rgr_mod6, condVar = T))


```

Conditional and marginal R^2^ estimated for the diameter model `r MuMIn::r.squaredGLMM(rgr_model)`

The nonnative species autumn olive had the best performance in terms of relative growth rate (height), followed by privet. The native redbud and, and nonnative honeysuckle, had similar baseline performance in relative growth rate. Spicebush had the lowest relative growth rate. The effects of the explanatory variables on relative growth rate were all in the same directions as for diameter and biomass.

**Plot marginal effect of distance on relative growth rate for each species**
```{r sjplot-rgr}

# sjPlot::sjp.lmer(rgr_model, type = "ri.slope")

rgr_sjplot <- sjPlot::sjp.lmer(rgr_model, type = "ri.slope", prnt.plot = F)
rgr_distance <- rgr_sjplot$plot[[5]]
(rgr_distance_lines <- rgr_distance +
  # geom_abline(intercept = rgr_summary$coefficients[1,1], slope = -(1/3))
  # geom_line() +
  # geom_point(data = site_grouped_data, aes(distance, log(avg_biomass))) +
  scale_color_brewer(palette = "BrBG") +
  labs(y = "Relative growth rate (% / day)", x = "Distance", title = "") +
  theme_classic() +
  theme(legend.title = element_blank())
)

```

**Plot the random-slope-random-intercept for the marginal effect of herbiory on the relative growth rate of each species**
```{r rgr-herbiv-by-species}

rgr_rsri_sjplot <- sjPlot::sjp.lmer(rmod_herbiv3, type = "rs.ri", show.legend = T, prnt.plot = F)# avg herbiv. incidence
# sjPlot::sjp.lmer(rmod_herbiv4, type = "rs.ri")# cumulative herbiv. incidence

rgr_rsri_plot <- rgr_rsri_sjplot$plot[[1]]
(rgr_rsri_plot <- rgr_rsri_plot + 
  theme_classic() +
  xlab("Avg. herbivory incidence") +
  ylab("Relative growth rate (% / day)") +
  ggtitle("") +
  theme(legend.position = c(.7,.9),
        legend.direction = "horizontal",
        legend.title = element_blank()) +
  scale_color_brewer(palette = "BrBG", breaks=c("Autumn olive","Dogwood","Honeysuckle","Redbud","Privet","Spicebush"))
  # the 'breaks' reorder the horizontal legend to have the plants grouped in each row
)

```


## Multipanel figures of growth model results: figures 1-3

```{r fig1-growth-fixed-coefs, fig.width=8, fig.height=3}

biomass_fixef_plot <- biomass_scaled_coef_plot + 
  ggtitle("Biomass")

diam_fixef_plot <- diam_scaled_coef_plot + 
  ggtitle("Diameter") +
  theme(axis.text.y = element_blank())

rgr_fixef_plot <- rgr_scaled_coef_plot + 
  ggtitle("RGR") +
  theme(axis.text.y = element_blank())


cowplot::plot_grid(plotlist = list(
  biomass_fixef_plot, diam_fixef_plot, rgr_fixef_plot
), nrow = 1, rel_widths = c(1.7,1,1), scale = .93, labels = "auto", label_x = c(.4,.1,.1))

# ggsave("figures/growth-scaled-coefs-fig.eps", width = 8, height = 3)

```

**Fig. 1.:** Coefficient estimates (and 95% confidence intervals) of scaled coefficients for distance, forest successional age, percent available light, and herbivory on biomass, diameter, and relative growth rate (height). 


```{r fig2-species-growth-diff, fig.width=9, fig.height=10}

## random intercepts for species
biomass_species_ranef_plot$data$grp <- factor(
  biomass_species_ranef_plot$data$grp, 
  levels = c("Spicebush", "Redbud", "Dogwood", "Privet", "Honeysuckle", "Autumn olive"))
biomass_species_ranef_plot <- biomass_species_ranef_plot + 
  ggtitle("") +
  geom_point(aes(color = grp), size = 3, show.legend = F) +
  scale_color_brewer(palette = "BrBG", direction = -1)
  
diam_species_ranef_plot$data$grp <- factor(
  biomass_species_ranef_plot$data$grp, 
  levels = c("Spicebush", "Redbud", "Dogwood", "Privet", "Honeysuckle", "Autumn olive"))
diam_species_ranef_plot <- diam_species_ranef_plot + 
  ggtitle("") +
  geom_point(aes(color = grp), size = 3, show.legend = F) +
  scale_color_brewer(palette = "BrBG", direction = -1)

rgr_species_ranef_plot$data$grp <- factor(
  biomass_species_ranef_plot$data$grp, 
  levels = c("Spicebush", "Redbud", "Dogwood", "Privet", "Honeysuckle", "Autumn olive"))
rgr_species_ranef_plot <- rgr_species_ranef_plot + 
  ggtitle("") +
  geom_point(aes(color = grp), size = 3, show.legend = F) +
  scale_color_brewer(palette = "BrBG", direction = -1)

## Random intercept plots of distance marginal effect ####
biomass_ri_distance <- biomass_distance_lines + 
  theme(legend.position = "none",
        legend.direction = "horizontal",
        legend.background = element_blank()) +
  scale_color_brewer(palette = "BrBG") +
  xlab("")

diam_ri_distance <- diam_distance_lines + 
  theme(legend.position = "none") +
  scale_color_brewer(palette = "BrBG") +
  xlab("")

rgr_ri_distance <- rgr_distance_lines + 
  theme(legend.position = "none") +
  scale_color_brewer(palette = "BrBG")


## Multipanel plot of species random intercepts for growth ####
cowplot::plot_grid(plotlist = list(
  biomass_species_ranef_plot, biomass_ri_distance,  
  diam_species_ranef_plot, diam_ri_distance, 
  rgr_species_ranef_plot, rgr_ri_distance), 
  nrow = 3, ncol = 2, rel_widths = c(1,2))

# ggsave(filename = "figures/distance-intercepts-opt2.eps", width = 9, height = 10)

```

**Fig. 2.:** Random intercepts relative to the and the marginal effect of distance for growth metrics of each species.


```{r fig3-growth-herbiv-species, width = 5, height = 5}

biomass_rsri_plot <- 
  biomass_herbiv_rsri_plot +
  xlab("") +
  theme(legend.position = c(.5,1),
        legend.direction = "horizontal",
        legend.background = element_blank()) +
  scale_color_brewer(palette = "BrBG", breaks=c("Autumn olive","Dogwood","Honeysuckle","Redbud","Privet","Spicebush"))
  
diameter_rsri_plot <- diam_rsri_plot +
  theme(legend.position = "none") +
  scale_color_brewer(palette = "BrBG")
# rgr_rsri_plot

cowplot::plot_grid(biomass_rsri_plot, diameter_rsri_plot, 
                   nrow=2)

# ggsave("figures/growth-rsri-plot-fig3.eps", width = 5, height = 5)

```

**Fig. 3.:** 


## Growth performance results
Seedling growth metrics of biomass, diameter, and relative growth rate of height  all responded similarly to edge effects, moisture and light availability, and forest successional age. Growth increased with light availability and was greater in young forests and decreased with distance from edge and moisture availability. The nonnative species generally performed better than the native species, however, there was species specific variability among growth metrics. The nonnative species privet, autumn olive, and honeysuckle had the best performance in terms of above-ground biomass relative to the overall average, while the native dogwood and spicebush generated relatively small amounts of biomass. The average biomass produced by the native redbud was close to the overall average across all the species. Privet also showed the greatest increase in diameter relative to the other species, while dogwood and especially spicebush had relatively small increases in diameter. Autumn olive and privet had the two highest relative growth rates in height and spicebush had the lowest. Relative growth rates of redbud, dogwood, and honeysuckle were similar, and near the overall average across all species.

## Percent germination model

Logistic regression with number of trials (seeds germinated:seeds recovered)

```{r find pct germination model, eval=F}

hist((germination_data$pct_germinated))
names(germination_data)


# find random component ----
germ_mod1 <- glm(cbind(seeds_germinated,seeds_present) ~ distance*avg_pct_light + distance*age + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture, family = "binomial", data = filter(germination_data, is.na(seeds_germinated)=="FALSE"))

germ_mod2 <- glmer(cbind(seeds_germinated,seeds_present) ~ distance*avg_pct_light + distance*age + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code), data = germination_data, family = "binomial")

germ_mod3 <- glmer(cbind(seeds_germinated,seeds_present) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (distance|site_code), data = germination_data, family = "binomial")

germ_mod4 <- glmer(cbind(seeds_germinated,seeds_present) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code) + (1|common_name), data = germination_data, family = "binomial")

germ_mod4a <- glmer(cbind(seeds_germinated,seeds_present) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code/common_name), data = germination_data, family = "binomial")

germ_mod4b <- glmer(cbind(seeds_germinated,seeds_present) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (distance|site_code/common_name), data = germination_data, family = "binomial")

germ_mod5 <- glmer(cbind(seeds_germinated,seeds_present) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (distance|site_code) + (1|common_name), data = germination_data, family = "binomial")

# rgr_mod6 <- lmer((avg_rgr_ht) ~ distance*avg_pct_light + avg_basal_area*age + distance*litter_kg_m2 + distance*pct_moisture + (1|site_code) + (distance|common_name), data = site_grouped_data)

AIC(germ_mod1)
AIC(germ_mod2)
AIC(germ_mod3)
AIC(germ_mod4)# 2nd best model, and small diff in AIC
AIC(germ_mod5)# best random effects model based on AIC
# AIC(germ_mod6)
anova(germ_mod4,germ_mod5)
anova(germ_mod4, germ_mod4a)
anova(germ_mod4,germ_mod4b)
anova(germ_mod4a,germ_mod4b)
# reinforcing that the difference between models isn't especially strong

# find fixed component ----
# germ_mod4_ML <- refitML(germ_mod4)
form <- formula(cbind(seeds_germinated,seeds_present) ~ avg_pct_light + avg_basal_area * age + distance * litter_kg_m2 + distance * pct_moisture + (1 | site_code) + (1 | common_name))
germ_mod4a <- glmer(form, data = germination_data, family = "binomial")
anova(germ_mod4, germ_mod4a)
summary(germ_mod4a)

form <- formula(cbind(seeds_germinated,seeds_present) ~ avg_pct_light + avg_basal_area * age + litter_kg_m2 + distance * pct_moisture + (1 | site_code) + (1 | common_name))
germ_mod4b <- glmer(form, data = germination_data, family = "binomial")
anova(germ_mod4a, germ_mod4b)
summary(germ_mod4b)

form <- formula(cbind(seeds_germinated,seeds_present) ~ distance + avg_pct_light + avg_basal_area * age + litter_kg_m2 + pct_moisture + (1 | site_code) + (1 | common_name))
germ_mod4c <- glmer(form, data = germination_data, family = "binomial")
anova(germ_mod4b, germ_mod4c)
summary(germ_mod4c)

form <- formula(cbind(seeds_germinated,seeds_present) ~ distance + avg_pct_light + avg_basal_area * age + litter_kg_m2 + (1 | site_code) + (1 | common_name))
germ_mod4d <- glmer(form, data = germination_data, family = "binomial")
anova(germ_mod4c, germ_mod4d)
summary(germ_mod4d)

# strong correlation among basal area and age; we know that basal area depends on age and don't have a biological explanation for basal area, so keeping age and excluding basal area makes sense I think

germ_model1 <- glmer(cbind(seeds_germinated,seeds_present) ~ distance + avg_pct_light + age + litter_kg_m2 + (1 | site_code) + (1 | common_name), data = germination_data, family = "binomial")
summary(germ_model1)
# pct light not very important
germ_model2 <- glmer(cbind(seeds_germinated,seeds_present) ~ distance + age + litter_kg_m2 + (1 | site_code) + (1 | common_name), data = germination_data, family = "binomial")
summary(germ_model2)

germ_model3 <- glmer(cbind(seeds_germinated,seeds_present) ~ distance + age + (1 | site_code) + (1 | common_name), data = germination_data, family = "binomial")
summary(germ_model3)

anova(germ_model2,germ_model3)


```

```{r final germination model}

germ_model <- glmer(cbind(seeds_germinated,seeds_present) ~ distance + age + litter_kg_m2 + (1 | site_code) + (1 | common_name), data = germination_data, family = "binomial")
summary(germ_model)

plot(germ_model)


# boxplot(E2 ~ distance, data = germ_model@frame)
# boxplot(E2 ~ age, data = germ_model@frame)
E2 <- resid(germ_model, type = "deviance")
plot(fitted(germ_model),E2)

plot(germ_model@frame$distance, E2)
# plot(germ_model@frame$avg_pct_light, E2)
# maybe some pattern here with light availability, but difficult to make out
# plot(germ_model@frame$avg_basal_area, E2)
plot(germ_model@frame$litter_kg_m2, E2)
plot(germ_model@frame$age, E2)

germination_data <- germination_data %>% 
  mutate(scaled_distance = distance/max(distance),
         scaled_pct_light = (avg_pct_light-mean(avg_pct_light))/(2*sd(avg_pct_light)),
         scaled_basal_area = (avg_basal_area-mean(avg_basal_area))/(2*sd(avg_basal_area)),
         scaled_litter_kg_m2 = (litter_kg_m2-mean(litter_kg_m2))/(2*sd(litter_kg_m2))
         )

germ_model_scaled <- glmer(cbind(seeds_germinated,seeds_present) ~ scaled_distance + age + scaled_litter_kg_m2 +  (1 | site_code) + (1 | common_name), data = germination_data, family = "binomial")
summary(germ_model_scaled)

```

```{r germ-species-ranef-plot}

germ_ranef <- ranef(germ_model_scaled, condVar = T)
germ_ranef_df <- as.data.frame(germ_ranef)
write.csv(germ_ranef_df, "model_output_data/germ_ranef.csv")

(germ_species_ranef_plot <- ggplot(filter(germ_ranef_df, grpvar=="common_name"), 
       aes(y = grp, x = condval)) +
  geom_point() +
  geom_errorbarh(aes(xmin = condval - 2*condsd, xmax = condval + 2*condsd), height = 0) +
  geom_vline(xintercept = 0, color = "gray70") +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("Species germination intercepts"))

```

```{r germ-site-ranef-plot}
(germ_site_ranef_plot <- ggplot(filter(germ_ranef_df, grpvar=="site_code"), 
       aes(y = grp, x = condval)) +
  geom_point() +
  geom_errorbarh(aes(xmin = condval - 2*condsd, xmax = condval + 2*condsd), height = 0) +
  geom_vline(xintercept = 0, color = "gray70") +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("Site germination intercepts"))
```


```{r germ-fixef-plot-data, eval=F}
# germ_summary <- summary(germ_model)
# str(germ_summary)
var_names <- c("Intercept","Distance", "Forest age: young","Litter mass")
# germ_fixed <- as.data.frame(germ_summary$coefficients)
# germ_fixed$var_names <- var_names
# germ_confint <- as.data.frame(confint(germ_model))
# germ_confint <- germ_confint[-c(1:2),]
# germ_fixed <- cbind(germ_fixed, germ_confint)
# # str(germ_fixed)
# 
# (germ_coef_plot <- ggplot(filter(germ_fixed, var_names!="Intercept"), 
#        aes(y = var_names, x = Estimate)) +
#   # coord_flip() +
#   geom_vline(xintercept = 0, color = "gray70") +
#   geom_point(size = 2) +
#   geom_errorbarh(aes(xmin = `2.5 %`, xmax = `97.5 %`), height = 0) +
#   theme_classic() +
#   theme(axis.text.y = element_text(size = 12),
#         axis.text.x = element_text(size = 12),
#         plot.title = element_text(hjust = .5, size = 18)
#         ) +
#   labs(x="", y="") +
#   ggtitle("Means Â± 95% confidence intervals - germ"))


germ_scaled_summary <- summary(germ_model_scaled)
# str(germ_scaled_summary)
germ_scaled_coef <- as.data.frame(germ_scaled_summary$coefficients)
germ_scaled_coef$var_names <- var_names
germ_confint <- as.data.frame(confint(germ_model_scaled))
germ_confint <- germ_confint[-c(1:2),]
germ_scaled_coef <- cbind(germ_scaled_coef, germ_confint)
write_csv(germ_scaled_coef, "model_output_data/germ_fixed_coef.csv")

```


```{r germ-fixef-plot}

germ_scaled_coef <- read_csv("model_output_data/germ_fixed_coef.csv")

(germ_scaled_coef_plot <- ggplot(filter(germ_scaled_coef, var_names!="Intercept"), 
       aes(y = var_names, x = Estimate)) +
  # coord_flip() +
  geom_vline(xintercept = 0, color = "gray70") +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = `2.5 %`, xmax = `97.5 %`), height = 0) +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("(Scaled) means Â± 95% confidence intervals - germ")
  )

```


```{r sjplot-germination}

# sjPlot::sjp.glmer(germ_model_scaled, type = "fe")

germ_sjplot <- sjPlot::sjp.glmer(germ_model, type = "ri.slope", facet.grid = F, prnt.plot = F)

germ_distance <- germ_sjplot$plot[[4]]
(germ_distance_lines <- germ_distance +
  labs(y = "Predicted germination probability", x = "Distance (m)") +
  ggtitle("") +
  theme_classic() +
  theme(legend.title = element_blank()) +
  # viridis::scale_color_viridis(discrete = T, begin = .01, end = .999, option = "inferno")
  scale_color_brewer(palette = "BrBG")
)

germ_litter <- germ_sjplot$plot[[6]]
(germ_litter_lines <- germ_litter +
  labs(y = "Predicted germination probability", x = "Litter (kg/m2)") +
  ggtitle("") +
  theme_classic() +
  theme(legend.title = element_blank()) +
  # viridis::scale_color_viridis(discrete = T, begin = .01, end = .99, option = "A")
  scale_color_brewer(palette = "BrBG")
)

```


## Seedling survival model
Logistic regression to estimate species-level survival probabilities.

```{r find survival model, eval=F}
# find random component ----
survival_2006 <- survival_2006 %>% 
  mutate(
    scaled_distance = distance/max(distance),
    scaled_pct_light = scale(avg_pct_light),
    scaled_basal_area = scale(avg_basal_area),
    scaled_litter_kg_m2 = scale(litter_kg_m2),
    scaled_pct_moisture = scale(pct_moisture)
  )

surv_mod1 <- glm(cbind(alive,dead) ~ scaled_distance*scaled_pct_light + scaled_distance*age + scaled_basal_area*age + scaled_distance*scaled_litter_kg_m2 + scaled_distance*scaled_pct_moisture, data = survival_2006, family = "binomial")

surv_mod2 <- glmer(cbind(alive,dead) ~ scaled_distance*scaled_pct_light + scaled_distance*age + scaled_basal_area*age + scaled_distance*scaled_litter_kg_m2 + scaled_distance*scaled_pct_moisture + (1|site_code), data = survival_2006, family = "binomial")

surv_mod3 <- glmer(cbind(alive,dead) ~ scaled_distance*scaled_pct_light + scaled_distance*age + scaled_basal_area*age + scaled_distance*scaled_litter_kg_m2 + scaled_distance*scaled_pct_moisture + (distance|site_code), data = survival_2006, family = "binomial")

surv_mod4 <- glmer(cbind(alive,dead) ~ scaled_distance*scaled_pct_light + scaled_distance*age + scaled_basal_area*age + scaled_distance*scaled_litter_kg_m2 + scaled_distance*scaled_pct_moisture + (1|site_code) + (1|common_name), data = survival_2006, family = "binomial")

surv_mod4a <- glmer(cbind(alive,dead) ~ scaled_distance*scaled_pct_light + scaled_distance*age + scaled_basal_area*age + scaled_distance*scaled_litter_kg_m2 + scaled_distance*scaled_pct_moisture + (1|site_code/common_name), data = survival_2006, family = "binomial")

# surv_mod4b <- glmer(cbind(alive,dead) ~ cbind(alive,dead) ~ scaled_distance*scaled_pct_light + scaled_distance*age + scaled_basal_area*age + scaled_distance*scaled_litter_kg_m2 + scaled_distance*scaled_pct_moisture + (scaled_distance|site_code/common_name), data = survival_2006, family = "binomial")

surv_mod5 <- glmer(cbind(alive,dead) ~ scaled_distance*scaled_pct_light + scaled_distance*age + scaled_basal_area*age + scaled_distance*scaled_litter_kg_m2 + scaled_distance*scaled_pct_moisture + (scaled_distance|site_code) + (1|common_name), data = survival_2006, family = "binomial")

surv_mod6 <- glmer(cbind(alive,dead) ~ scaled_distance*scaled_pct_light + scaled_distance*age + scaled_basal_area*age + scaled_distance*scaled_litter_kg_m2 + scaled_distance*scaled_pct_moisture + (1|site_code) + (scaled_distance|common_name), data = survival_2006, family = "binomial")

AIC(surv_mod1)
AIC(surv_mod2)
AIC(surv_mod3)
AIC(surv_mod4)# 2nd best model, and small diff in AIC
AIC(surv_mod5)# best random effects model based on AIC
# AIC(surv_mod6)
AIC(surv_mod6)
anova(surv_mod4,surv_mod5)
anova(surv_mod4, surv_mod4a)
# anova(surv_mod4,surv_mod4b)
# anova(surv_mod4a,surv_mod4b)
# mod4b is the best alternative based on AIC, but the BIC is actually greater
# I'm not sure that I would be able to interpret this model

summary(surv_mod4)

# find fixed component ----
survival_2006 <- filter(survival_2006, !is.na(alive))
surv_mod <- glmer(cbind(alive,dead) ~ scaled_distance*scaled_pct_light + scaled_distance*age + scaled_basal_area*age + scaled_distance*scaled_litter_kg_m2 + scaled_distance*scaled_pct_moisture + (1|site_code) + (1|common_name), data = survival_2006, family = "binomial", na.action = "na.fail")
# m4_dredge <- MuMIn::dredge(surv_mod)
# filter(m4_dredge, delta <3)
## This model dredging indicated that the random-effects only model was actually the best, but the weighting across the models is rather small. The top 7 models have a change in AICc of less than 2

# surv_mod4_ML <- refitML(surv_mod4)

surv_mod_null <- glm(cbind(alive,dead) ~ 1, data = survival_2006, family="binomial")
summary(surv_mod_null)
surv_mod_ranef <- glmer(cbind(alive,dead) ~ (1|site_code) + (1|common_name), data = survival_2006, family = "binomial")
## remove distance:moisture interaction
surv_mod4a <- glmer(cbind(alive,dead) ~ scaled_distance*scaled_pct_light + scaled_basal_area*age + scaled_distance*scaled_litter_kg_m2 + (1|site_code) + (1|common_name), data = survival_2006, family = "binomial")
anova(surv_mod4, surv_mod4a)
anova(surv_mod_ranef, surv_mod4a)
summary(surv_mod4a)

## remove unconvincing distance:litter interaction (testing on the boundary)
form <- formula(cbind(alive,dead) ~ scale(distance)*scale(avg_pct_light) + scale(avg_basal_area)*age + scale(litter_kg_m2) + (1|site_code) + (1|common_name))
surv_mod4b <- glmer(form, data = survival_2006, family = "binomial")
anova(surv_mod4a, surv_mod4b)
# mod4b isn't actually any better/different informationally than mod4a
# summary(surv_mod4b)

## remove the now unconvincing distance:light interaction
form <- formula(cbind(alive,dead) ~ scale(distance) + scale(avg_pct_light) + scale(avg_basal_area)*age + scale(litter_kg_m2) + (1|site_code) + (1|common_name))
surv_mod4c <- glmer(form, data = survival_2006, family = "binomial")
anova(surv_mod4b, surv_mod4c)
summary(surv_mod4c)
## I'm kind of flailiing around here; I think it's most interesting ecologically if I use the same set of predictor variables as for the germination model. This enables a comparison of whether the same things affecting germinatino probability also affect survival probability.

form <- formula(cbind(alive,dead) ~ distance + avg_pct_light + avg_basal_area * age + litter_kg_m2 + (1 | site_code) + (1 | common_name))
surv_mod4d <- glmer(form, data = survival_2006, family = "binomial")
anova(surv_mod4a, surv_mod4d)
summary(surv_mod4d)
# That doesn't really tell us much, except that the variables don't explain survival probability very well

# I revised the germination model to deal with collinearity, so will do the same here
surv_model1 <- glmer(cbind(alive,dead) ~ distance + avg_pct_light + avg_basal_area * age + litter_kg_m2 + (1 | site_code) + (1 | common_name), family = "binomial", data = survival_2006)
summary(surv_model1)
# remove basal area and interaction with age
surv_model2 <- glmer(cbind(alive,dead) ~ distance + avg_pct_light + age + litter_kg_m2 + (1 | site_code) + (1 | common_name), family = "binomial", data = survival_2006)
summary(surv_model2)
# it doesn't look like any of the explanatory variables have an effect, so i'm going to match it with the germination model
surv_model2 <- glmer(cbind(alive,dead) ~ distance + age + litter_kg_m2 + (1 | site_code) + (1 | common_name), family = "binomial", data = survival_2006)
summary(surv_model2)

```

```{r final survival model}
survival_2006 <- survival_2006 %>% 
  mutate(
    scaled_distance = distance/max(distance),
    scaled_pct_light = scale(avg_pct_light),
    scaled_basal_area = scale(avg_basal_area),
    scaled_litter_kg_m2 = scale(litter_kg_m2),
    scaled_pct_moisture = scale(pct_moisture)
  )

survival_2006$obs_id <- seq_along(survival_2006$age)

surv_model <- glmer(cbind(alive,dead) ~ distance + age + litter_kg_m2 + (1|site_code) + (1|common_name) + (1|obs_id), data = survival_2006, family = "binomial")
summary(surv_model)

surv_model_scaled <- glmer(cbind(alive,dead) ~ scaled_distance + age + scaled_litter_kg_m2 + (1|site_code) + (1|common_name), data = survival_2006, family = "binomial")

summary(surv_model_scaled)
plot(surv_model_scaled)

e2 <- resid(surv_model_scaled, type = "deviance")

ggplot(as.data.frame(cbind(fitted(surv_model_scaled),e2)),
       aes(fitted(surv_model_scaled), e2)) +
  geom_point() +
  geom_smooth()

plot(surv_model_scaled@frame$scaled_distance, e2)
lines(lowess(e2~surv_model_scaled@frame$scaled_distance))
# plot(survival_2006$age, e2)# error
# plot(survival_2006$scaled_basal_area, e2)
# lines(lowess(e2~survival_2006$scaled_basal_area))
# plot(survival_2006$scaled_pct_light, e2)
# lines(lowess(e2~survival_2006$scaled_pct_light))
plot(surv_model_scaled@frame$scaled_litter_kg_m2, e2)
lines(lowess(e2~surv_model_scaled@frame$scaled_litter_kg_m2))

# interplot::interplot(surv_model, "scaled_litter_kg_m2","scaled_distance")
# interplot::interplot(surv_model, "scaled_pct_light","scaled_distance")
# interplot::interplot(surv_model, "scaled_basal_area","age")

```

### Survival model random intercepts
```{r surv-species-ranef-plot}

surv_ranef <- ranef(surv_model, condVar = T)
surv_ranef_df <- as.data.frame(surv_ranef)
write.csv(surv_ranef_df, "model_output_data/survival_ranef.csv")

(surv_species_ranef_plot <- 
    ggplot(filter(surv_ranef_df, grpvar=="common_name"), 
       aes(y = grp, x = condval)) +
  geom_point() +
  geom_errorbarh(aes(xmin = condval - 2*condsd, xmax = condval + 2*condsd), height = 0) +
  geom_vline(xintercept = 0, color = "gray70") +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("Species survival probability intercepts"))

# predict(surv_model)
```


```{r surv-site-ranef-plot}
(surv_site_ranef_plot <- ggplot(filter(surv_ranef_df, grpvar=="site_code"), 
       aes(y = grp, x = condval)) +
  geom_point() +
  geom_errorbarh(aes(xmin = condval - 2*condsd, xmax = condval + 2*condsd), height = 0) +
  geom_vline(xintercept = 0, color = "gray70") +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("Site survival probability intercepts"))


```


```{r surv-fixef-plot-data, eval=F}

surv_summary <- summary(surv_model_scaled)
# str(surv_summary)
var_names <- c("Intercept","Distance","Forest age: young","Litter mass")
surv_fixed <- as.data.frame(surv_summary$coefficients)
surv_fixed$var_names <- var_names
surv_confint <- as.data.frame(confint(surv_model_scaled))
surv_confint <- surv_confint[-c(1,2),]
surv_fixed <- cbind(surv_fixed, surv_confint)
# str(surv_fixed)
write_csv(surv_fixed, "model_output_data/survival_fixed_coef.csv")

```


```{r surv-fixef-plot}

surv_fixed <- read_csv("model_output_data/survival_fixed_coef.csv")

(surv_coef_plot <- ggplot(filter(surv_fixed, var_names!="Intercept"),
       aes(y = var_names, x = Estimate)) +
  # coord_flip() +
  geom_vline(xintercept = 0, color = "gray70") +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = `2.5 %`, xmax = `97.5 %`), height = 0) +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        plot.title = element_text(hjust = .5, size = 18)
        ) +
  labs(x="", y="") +
  ggtitle("Survival scaled means Â± 95% CI"))

# surv_scaled_summary <- summary(surv_model_scaled)
# # str(surv_scaled_summary)
# surv_scaled_coef <- as.data.frame(surv_scaled_summary$coefficients)
# surv_scaled_coef$var_names <- var_names
# surv_confint <- as.data.frame(confint(surv_model_scaled))
# surv_confint <- surv_confint[-c(1:2),]
# surv_scaled_coef <- cbind(surv_scaled_coef, surv_confint)

# (surv_scaled_coef_plot <- ggplot(filter(surv_scaled_coef, var_names!="Intercept"), 
#        aes(y = var_names, x = Estimate)) +
#   # coord_flip() +
#   geom_vline(xintercept = 0, color = "gray70") +
#   geom_point(size = 2) +
#   geom_errorbarh(aes(xmin = `2.5 %`, xmax = `97.5 %`), height = 0) +
#   theme_classic() +
#   theme(axis.text.y = element_text(size = 12),
#         axis.text.x = element_text(size = 12),
#         plot.title = element_text(hjust = .5, size = 18)
#         ) +
#   labs(x="", y="") +
#   ggtitle("(Scaled) means Â± 95% confidence intervals - surv")
#   )

```

The estimated marginal and condiational R^2^ values reinforce that the fixed effects don't explain the variance in seedling survival: 

`r MuMIn::r.squaredGLMM(surv_model)`

```{r survival-sjplot}

surv_model <- glmer(cbind(alive, dead) ~ distance + age + litter_kg_m2 + (1 | site_code) + (1 | common_name), data = survival_2006, family = "binomial")

surv_sjplot <- sjPlot::sjp.glmer(surv_model, type = "ri.slope", facet.grid = F, prnt.plot = F)
surv_distance <- surv_sjplot$plot[[4]]
(surv_distance_lines <- surv_distance +
  labs(y = "Predicted survival probability", x = "Distance (m)") +
  ggtitle("") +
  theme_classic() +
  theme(legend.title = element_blank()) +
  # viridis::scale_color_viridis(discrete = T, begin = .01, end = .999, option = "inferno")
  scale_color_brewer(palette = "BrBG")
)

```


## Germination and survival results
The probability of germination increased with distance from edge, light availability, litter mass, and basal area, but the effect of basal area was moderated by forest successional age, with lower germination in young forests. Effects of measured site conditions on survival were relatively weak and predominantly due to interaction variables. Light availability had a significant positive effect on survival probability, but this decreased with distance from the edge (indicated by the negative interaction term). The positive interaction of distance and litter increased survival probability, although the main effects of distance and litter were statistically insignificant. The interaction of basal area and forest age was similar, but with a negative effect where seedlings at locations with lower basal area in younger forests had lower probability of survival. Variation in survival depended predominantly on species specific characteristics and unmeasured site characteristics as indicated by the variance accounted for by these random effects variables.

Germination probability for the nonnative autumn olive and honeysuckle, and native dogwood was greater than the overall average; privet, redbud, and spicebush had below average germination, with spicebush being the lowest. In contrast, the transplanted autumn olive and dogwood seedlings had the lowest survival probability, while honeysuckle, privet, spicebush, and redbud seedlings all showed above average survival. Honeysuckle seedlings were particularly likely to persist to the end of the experiment.

```{r fig4-germ-survival}

germ_species_ranef_plot$data$grp <- factor(
  germ_species_ranef_plot$data$grp, 
  levels = c("Spicebush", "Redbud", "Dogwood", "Privet", "Honeysuckle", "Autumn olive")
)
germ_ranef_plot <- germ_species_ranef_plot +
  geom_point(aes(color = grp), size = 3, show.legend = F) +
  scale_color_brewer(palette = "BrBG", direction = -1) +
  ggtitle("")
  
surv_species_ranef_plot$data$grp <- factor(
  surv_species_ranef_plot$data$grp,
  levels = c("Spicebush", "Redbud", "Dogwood", "Privet", "Honeysuckle", "Autumn olive")
)
surv_ranef_plot <- surv_species_ranef_plot +
  geom_point(aes(color = grp), size = 3, show.legend = F) +
  scale_color_brewer(palette = "BrBG", direction = -1) +
  ggtitle("")

germ_dist_plot <- germ_distance_lines +
  theme(legend.position = "none")
surv_dist_plot <- surv_distance_lines +
  theme(legend.position = "none")


cowplot::plot_grid(
  germ_ranef_plot,germ_dist_plot,surv_ranef_plot,surv_dist_plot,
  ncol = 2, nrow = 2, labels = "auto")

ggsave("figures/fig4-germ-surv.eps", height = 6, width = 6)
```


## Site-level effects
Growth was relativley poor for all the metrics at the DG, FR, and GR, and tended to be greatest at the CH and PR sites. In addition to the CH and PR sites, seedlings at the LD and SR sites tended to perform well in terms of biomass; seedling diameters at the TC and SR sites were also greater than average, but lagged well-behind the CH site; relative-growth-rate tended to be greater than average at the BB and LD, but the PR site was the best for this variable. In terms of survival, the CH site was the most favorable, while seedling survival was similar and above average at the TC, DU, and PR sites. Probability of germination was close to the average across most of the site, but exceptionally greater at the DB site, and exceptionally lower at the DU site. 

```{r gridded-site-ranef-fig}
cowplot::plot_grid(plotlist = list(biomass_site_ranef_plot, diam_site_ranef_plot, rgr_site_ranef_plot, surv_site_ranef_plot, germ_site_ranef_plot))
```

## Herbivory model
General model formulation: herbivory ~ distance + age + year + pct_light + litter

I'm not actually sure how to fit a model to these data. It's ordinal in that the categories indicate the range of herbivory in terms of leaf area affected. Herbivory was categorized as leaf-loss, where 

- 0 = no herbivory
- 1 = â‰¤25% 
- 2 = 26-50%
- 3 = 51-75%
- 4 = 76-99%
- 5 = 100% leaf removal by herbivores

The internet has some suggestions on how to do this for mixed-effects models: 
[](https://stats.stackexchange.com/questions/238581/how-to-use-ordinal-logistic-regression-with-random-effects?noredirect=1&lq=1)

The `ordinal` package has the `clmm` and `clmm2`, which will probably suffice for my purposes. I just need to get a decent inference off the data. Two other packages implement Bayesian MCMC frameworsks:  [MCMCglmm](https://cran.r-project.org/package=MCMCglmm) and [brms](https://cran.r-project.org/package=brms).

Other studies have looked at incidence, i.e., presence/absence of herbivory at each observation, so we could take that approach.

```{r ordinal-vs-incidence, eval=T}

summary(herbiv)
herbiv <- herbiv %>% 
  mutate(herbivory_incidence = ifelse(herbivory == 0,0,1))

herbiv_noNA_data <- filter(herbiv, !is.na(herbivory))
summary(herbiv_noNA_data)
hist(herbiv_noNA_data$herbivory)
herbiv_noNA_data <- herbiv_noNA_data %>% 
  mutate(herbivory_incidence = ifelse(herbivory == 0,0,1))

herb_ordinal <- ggplot(herbiv_noNA_data, aes(distance, herbivory)) +
  # geom_boxplot(aes(group = distance)) +
  geom_point(aes(color = status), position = "jitter") +
  geom_smooth(aes(color = status), method = "loess", show.legend = F) +
  facet_grid(age~year) +
  # scale_color_brewer(palette = 7) +
  xlab("") +
  theme_bw() +
  theme(strip.background = element_blank(),
        legend.position = "top",
        legend.title = element_blank()) +
  scale_color_manual(values = c("green4","tan2"))

herb_incidence <- ggplot(herbiv_noNA_data, aes(distance, herbivory_incidence)) +
  # geom_boxplot(aes(group = distance)) +
  geom_point(aes(color = status), position = "jitter") +
  geom_smooth(aes(color = status), method = "loess", show.legend = F) +
  facet_grid(age~year) +
  # scale_color_brewer(palette = 7) +
  theme_bw() +
  theme(strip.background = element_blank(),
        legend.position = "none") +
  scale_color_manual(values = c("green4","tan2"))

cowplot::plot_grid(plotlist = list(herb_ordinal, herb_incidence), nrow = 2)

```

```{r incident-herbivory-model}

herbiv_noNA_data$f_herbiv_incidence <- as.factor(herbiv_noNA_data$herbivory_incidence)

herbiv_incidence_mod <- glmer(f_herbiv_incidence ~ distance + age*year + status + (1|site_code) + (1|common_name), family = "binomial", data = herbiv_noNA_data)
summary(herbiv_incidence_mod)
AIC(herbiv_incidence_mod)

```


```{r ordinal-herbivory-model}
# install.packages("ordinal")
library(ordinal)
herbiv_noNA_data$f_herbiv <- as.factor(herbiv_noNA_data$herbivory)
herbiv_noNA_data$status <- factor(herbiv_noNA_data$status, levels = c("Non-native","Native"))

herbiv_ordinal_mod <- clmm(f_herbiv ~ distance + age*year + status + (1|site_code) + (1|common_name), data = herbiv_noNA_data)
summary(herbiv_ordinal_mod)

h_ord_mod2 <- clmm(f_herbiv ~ distance + age*year + status + (1|common_name), data = herbiv_noNA_data)
anova(herbiv_ordinal_mod, h_ord_mod2)

h_ord_mod3 <- clmm(f_herbiv ~ distance + age*year + status + (1|site_code), data = herbiv_noNA_data)
anova(herbiv_ordinal_mod, h_ord_mod3)

h_ord_mod4 <- clmm(f_herbiv ~ distance + age + year + status + (1|site_code) + (1|common_name), data = herbiv_noNA_data)
anova(herbiv_ordinal_mod, h_ord_mod4)

h_ord_mod5 <- clmm(f_herbiv ~ distance + age + status + (1|site_code) + (1|common_name), data = herbiv_noNA_data)
anova(herbiv_ordinal_mod, h_ord_mod5)


herbiv_ord_mod_ranef <- ranef(herbiv_ordinal_mod, condVar = T)
round(exp(herbiv_ordinal_mod$beta), 1)# cumulative odds ratio of herbivory>j for the explanatory variables
## none of the explanatory variables have an especially strong effect on the odds
round(exp(confint(herbiv_ordinal_mod, type = "Wald")), 1)# asymmetric 95% confidence intervals of the explanatory variables

# profile.clmm2(herbiv_ordinal_mod)

herbiv06_mod1 <- clmm(f_herbiv ~ distance + age + status + (1|site_code) + (1|common_name), data = filter(herbiv_noNA_data, year == 2006))
summary(herbiv06_mod1)

herbiv05_mod1 <- clmm(f_herbiv ~ distance + age + status + (1|site_code) + (1|common_name), data = filter(herbiv_noNA_data, year == 2005))
summary(herbiv05_mod1)

herbiv04_mod1 <- clmm(f_herbiv ~ distance + age + status + (1|site_code) + (1|common_name), data = filter(herbiv_noNA_data, year == 2004))
summary(herbiv04_mod1)

```


